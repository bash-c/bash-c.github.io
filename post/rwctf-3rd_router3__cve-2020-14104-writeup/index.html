<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>RWCTF-3rd router3 &amp; CVE-2020-14104 writeup - localhost - Done with development, it&#39;s time to pwn.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="M4x" />
  <meta name="description" content="" />
<meta name="keywords" content="RWCTF, CVE-2020-14104" />







<meta name="generator" content="Hugo 0.75.1" />


<link rel="canonical" href="https://bash-c.github.io/post/rwctf-3rd_router3__cve-2020-14104-writeup/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="RWCTF-3rd router3 &amp; CVE-2020-14104 writeup" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bash-c.github.io/post/rwctf-3rd_router3__cve-2020-14104-writeup/" />
<meta property="article:published_time" content="2021-02-06T17:40:46+08:00" />
<meta property="article:modified_time" content="2021-02-06T17:40:46+08:00" />
<meta itemprop="name" content="RWCTF-3rd router3 &amp; CVE-2020-14104 writeup">
<meta itemprop="description" content="">
<meta itemprop="datePublished" content="2021-02-06T17:40:46+08:00" />
<meta itemprop="dateModified" content="2021-02-06T17:40:46+08:00" />
<meta itemprop="wordCount" content="6598">



<meta itemprop="keywords" content="IoT," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RWCTF-3rd router3 &amp; CVE-2020-14104 writeup"/>
<meta name="twitter:description" content=""/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"># </a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      # 
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">RWCTF-3rd router3 &amp; CVE-2020-14104 writeup</h1>
      
      <div class="post-meta">
        <time datetime="2021-02-06" class="post-time">
          2021-02-06
        </time>
        <div class="post-category">
            <a href="https://bash-c.github.io/categories/writeup/"> writeup </a>
            
          </div>
        <span class="more-meta"> 6598 words </span>
          <span class="more-meta"> 14 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    

    
    <div class="post-content">
      <h1 id="writeup-for-rwctf-3rd-router3-and-real-writeup-for-cve-2020-14104">Writeup for RWCTF-3rd router3 and real writeup for CVE-2020-14104</h1>
<p>I made a challenge named <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3">router3</a> for <a href="https://ctftime.org/event/1198">RWCTF-3rd</a>. Team <a href="https://ctftime.org/team/143448">CodeR00t</a> ,<a href="https://blog.bushwhackers.ru/">Bushwhackers</a> and <a href="https://twitter.com/Sauercl0ud">Sauercloud</a> solved it during the game, congratulations to them!</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/coder00t.png" alt=""></p>
<blockquote>
<p>first blood was taken by <code>CodeR00t</code></p>
</blockquote>
<p>Here I want to share the writeup for <code>router3</code> and <code>CVE-2020-14104</code>(the related vuln)</p>
<h2 id="writeup-for-router3">Writeup for router3</h2>
<h3 id="information-of-the-challenge">information of the challenge</h3>
<p>In case the readers didn&rsquo;t participate in <code>RWCTF-3rd</code>, I paste the description below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">router3
Score: 477

web reverse demo


Geez, you can access some internal and experimental API using an awesome bug now! Try to exploit the [router](https://rwctf2021.s3-us-west-1.amazonaws.com/router3-a2dcb2d91d0654c87ffce982a86b8794723e76d6.tar.gz) completely next!

**root password is not set in the above attachments, but set in the demo environment**
</code></pre></td></tr></table>
</div>
</div><p>And the attachments</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">rwctf@rwctf:~/Desktop$ tar tvf router3.tar.gz
-rw-r--r-- root/root <span class="m">268435456</span> 2021-01-08 04:20 openwrt-armvirt-32-root.ext4
-rwxr-xr-x root/root   <span class="m">1880792</span> 2021-01-08 03:51 openwrt-armvirt-32-zImage
-rw-r--r-- root/root      <span class="m">1838</span> 2021-01-09 20:19 readme.md
-rwxr-xr-x root/root       <span class="m">749</span> 2021-01-08 03:54 start.sh
rwctf@rwctf:~/Desktop$ cat start.sh
<span class="c1">#!/bin/sh</span>
<span class="nv">IMAGE</span><span class="o">=</span>openwrt-armvirt-32-zImage
<span class="nv">LAN</span><span class="o">=</span>ledetap0
<span class="nv">DRIVE</span><span class="o">=</span>openwrt-armvirt-32-root.ext4
<span class="c1"># create tap interface which will be connected to OpenWrt LAN NIC</span>
ip tuntap add mode tap <span class="nv">$LAN</span>
ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> up
<span class="c1"># configure interface with static ip to avoid overlapping routes</span>
ip addr add 192.168.1.101/24 dev <span class="nv">$LAN</span>
qemu-system-arm <span class="se">\
</span><span class="se"></span>    -device virtio-net-pci,netdev<span class="o">=</span>lan <span class="se">\
</span><span class="se"></span>    -netdev tap,id<span class="o">=</span>lan,ifname<span class="o">=</span><span class="nv">$LAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\
</span><span class="se"></span>    -device virtio-net-pci,netdev<span class="o">=</span>wan <span class="se">\
</span><span class="se"></span>    -netdev user,id<span class="o">=</span>wan <span class="se">\
</span><span class="se"></span>    -drive <span class="nv">file</span><span class="o">=</span><span class="nv">$DRIVE</span>,format<span class="o">=</span>raw,if<span class="o">=</span>virtio -append <span class="s1">&#39;root=/dev/vda rootwait&#39;</span> <span class="se">\
</span><span class="se"></span>    -M virt -nographic -m <span class="m">256</span> -kernel <span class="nv">$IMAGE</span>
<span class="c1"># cleanup. delete tap interface created earlier</span>
ip addr flush dev <span class="nv">$LAN</span>
ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> down
ip tuntap del mode tap dev <span class="nv">$LAN</span>
rwctf@rwctf:~/Desktop$ file openwrt-armvirt-32-*
openwrt-armvirt-32-root.ext4: Linux rev 1.0 ext2 filesystem data <span class="o">(</span>mounted or unclean<span class="o">)</span>, <span class="nv">UUID</span><span class="o">=</span>57f8f4bc-abf4-655f-bf67-946fc0f9f25b <span class="o">(</span>extents<span class="o">)</span> <span class="o">(</span>large files<span class="o">)</span>
openwrt-armvirt-32-zImage:    ARM OpenFirmware FORTH Dictionary, Text length: -509607936 bytes, Data length: -509607936 bytes, Text Relocation Table length: -369098749 bytes, Data Relocation Table length: <span class="m">24061976</span> bytes, Entry Point: 0x00000000, BSS length: <span class="m">1880792</span> bytes
</code></pre></td></tr></table>
</div>
</div><p>Players are provided with a <code>qemu-launched</code> mips-system based on <a href="http://openwrt.org/">openwrt</a>. According to <code>readme.md</code>(a long document which describes some details for demo-show), the players are asked to achieve <code>RCE</code> or <code>arbitrary-file-write</code>, which could be leveraged to <code>RCE</code> too.</p>
<p>Summarize above information:</p>
<ul>
<li>
<p>What kind of challenge it is?</p>
<ul>
<li>web &amp; reverse</li>
</ul>
</li>
<li>
<p>What we have?</p>
<ul>
<li>a mips-system</li>
</ul>
</li>
<li>
<p>What we are supposed to do?</p>
<ul>
<li>full RCE</li>
</ul>
</li>
</ul>
<p>**So where the vuln should be? **</p>
<p>Launching this mips-system using <code>start.sh</code>(must be root), from the result of <code>netstat</code> and <code>ps</code>, it&rsquo;s clear that the only process related to <code>web</code> is <code>nginx</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:/# netstat -antpl
netstat: showing only processes with your user ID
Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      935/nginx.conf -g d
......
root@OpenWrt:/# ps
  PID USER       VSZ STAT COMMAND
......
  <span class="m">935</span> root      <span class="m">2404</span> S    nginx: master process /usr/sbin/nginx -c /etc/nginx/
  <span class="m">958</span> root      <span class="m">2452</span> S    nginx: worker process
......
</code></pre></td></tr></table>
</div>
</div><p>More specifically, it used <a href="https://openwrt.org/docs/techref/luci">luci</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:~# ls /www/
cgi-bin      index.html   luci-static
root@OpenWrt:~# ls /www/cgi-bin/
cgi-backup    cgi-download  cgi-exec      cgi-upload    luci
</code></pre></td></tr></table>
</div>
</div><p>Basically, <strong>luci = <a href="http://www.lua.org/">lua</a> + <a href="https://openwrt.org/docs/techref/uci">uci</a></strong>. In short, luci uses the Lua programming language and is based on some <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a>-Webframework.</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/MVC.svg" alt=""></p>
<p>So users can interact with <code>controller</code>. Let&rsquo;s focus on the <code>controller</code> code, which is located in <code>/usr/lib/lua/luci/controller</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:~# ls /usr/lib/lua/luci/controller/ -R
/usr/lib/lua/luci/controller/:
admin         api           firewall.lua  opkg.lua

/usr/lib/lua/luci/controller/admin:
index.lua    network.lua  uci.lua

/usr/lib/lua/luci/controller/api:
index.lua   system.lua
</code></pre></td></tr></table>
</div>
</div><p>Compared with standard <code>openwrt</code> system, clearly there is an extra file <code>/usr/lib/lua/luci/controller/api/system.lua</code> here. Probably it is the code that players should focus on.</p>
<p>So, let&rsquo;s take a look. But wait! Why it&rsquo;s an ELF file?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">rwctf@rwctf:~/Desktop$ file system.lua
system.lua: ELF 32-bit invalid byte order <span class="o">(</span>SYSV<span class="o">)</span>
rwctf@rwctf:~/Desktop$ hexdump -C -n <span class="m">20</span> ./system.lua
<span class="m">00000000</span>  7f <span class="m">45</span> 4c <span class="m">46</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>  <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">05</span>  <span class="p">|</span>.ELF............<span class="p">|</span>
<span class="m">00000010</span>  <span class="m">02</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span>                                       <span class="p">|</span>....<span class="p">|</span>
<span class="m">00000014</span>
rwctf@rwctf:~/Desktop$ chmod +x system.lua <span class="p">;</span> ./system.lua
Hello world
</code></pre></td></tr></table>
</div>
</div><p>Should we fire up <code>IDA pro</code> or some other decompilers? Of course not, we have known that luci heavily depends on lua. if we have checked <code>lua</code> version in the mips-system, we&rsquo;ll immediately realize that the lua binary is modified so the magic ELF header doesn&rsquo;t mean it&rsquo;s a real ELF file.</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/lua.png" alt=""></p>
<p>And that&rsquo;s why there is a tag <code>reverse</code> for the challenge. Players must do some reverse work and write a decompiler before auditing the lua code. I won&rsquo;t show you how to write a decompiler step by step because there have been lots of resources. But I can provide some good references<!-- raw HTML omitted --><a href="https://github.com/feicong/lua_re">1</a> <a href="https://bbs.pediy.com/thread-216969.htm">2</a><!-- raw HTML omitted -->(only in Chinese, sorry) and the <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3/files/310-rwctf-router3.patch">diff file</a>.</p>
<p>Next, let&rsquo;s take a break from the challenge and have a glance at <a href="https://privacy.mi.com/trust#/security/vulnerability-management/vulnerability-announcement/detail?id=15&amp;locale=en">CVE-2020-11960</a></p>
<h3 id="brief-introduction-to-cve-2020-11960">brief introduction to CVE-2020-11960</h3>
<p><code>CVE-2020-11960</code>, which I had presented on <a href="https://hitcon.org/2020/slides/Exploit%20(Almost)%20All%20Xiaomi%20Routers%20Using%20Logical%20Bugs.pdf">HITCON 2020</a>, mainly leveraged files left in <code>/tmp</code> when the uploading procedure failed, to achieve RCE.</p>
<p>You can check more details from page 33~55 of the slides and I will briefly introduce how I exploited this vuln here, too.</p>
<p>The exploit can be concluded into the following steps:</p>
<ol>
<li>Due to some trival flaws, we can upload two files <code>/tmp/hack_des.sh</code> &amp; <code>/tmp/dnsmasq.d/mbu.conf</code>, where <code>hack_des.sh</code> is a shell script containing arbitrary command and <code>mbu.conf</code> is a configuration file for <a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html">dnsmasq</a> with assigning <code>/tmp/hack_des.sh</code> as its <code>dhcp-script</code></li>
<li>restarting <code>dnsmasq</code> to load <code>mbu.conf</code></li>
<li>transfer some file via <code>tftp</code> and then <code>hack_des.sh</code> shall run</li>
</ol>
<p>The most foremost step is to be able to upload almost arbitrary files to <code>/tmp</code>, upon which we can construct the configuration file of <code>dnsmasq</code> to achieve RCE.</p>
<h3 id="writeup-from-players">Writeup from players</h3>
<p>Back to the challenge, there are not many interfaces in <code>system.lua</code>. The target should be obvious. I paste the related source code of <code>/api/system/c_upload</code> as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- /usr/lib/lua/luci/controller/api/system.lua</span>
	<span class="n">entry</span><span class="p">({</span><span class="s2">&#34;api&#34;</span><span class="p">,</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;c_upload&#34;</span><span class="p">},</span>              <span class="n">call</span><span class="p">(</span><span class="s2">&#34;cUpload&#34;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="mi">153</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span>							<span class="o">&lt;&lt;---</span> <span class="n">a</span>

<span class="kr">function</span> <span class="nf">cUpload</span><span class="p">()</span>
<span class="p">......</span>
    <span class="kd">local</span> <span class="n">uploadFilepath</span> <span class="o">=</span> <span class="s2">&#34;/tmp/cfgbackup.tar.gz&#34;</span>
<span class="p">......</span>
        <span class="kd">local</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">XQBackup.extract</span><span class="p">(</span><span class="n">uploadFilepath</span><span class="p">)</span>
<span class="p">......</span>
<span class="kr">end</span>

<span class="c1">-- /usr/lib/lua/xiaoqiang/module/XQBackup.lua</span>
<span class="kd">local</span> <span class="n">TMPDIR</span>     <span class="o">=</span> <span class="s2">&#34;bkcfg_tmp&#34;</span>

<span class="kr">function</span> <span class="nf">extract</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;nixio.fs&#34;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">tarpath</span> <span class="o">=</span> <span class="n">filepath</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">tarpath</span> <span class="kr">then</span>
        <span class="n">tarpath</span> <span class="o">=</span> <span class="n">TARMBUFILE</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="n">tarpath</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep ^l &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>								<span class="o">&lt;&lt;---</span> <span class="n">b</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep -v .des | grep -v .mbu &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>			<span class="o">&lt;&lt;---</span> <span class="n">c</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">22</span>
    <span class="kr">end</span>

    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;cd /tmp; mkdir &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; cd &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; tar -xzf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>	<span class="o">&lt;&lt;---</span> <span class="n">d</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.des&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.1</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.mbu&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.2</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;mv /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/* /tmp; rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>												<span class="o">&lt;&lt;---</span> <span class="n">f</span>
    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>This is a piece of easy-to-understand code snippet, with the following key points:</p>
<ul>
<li>
<p><strong>(a)</strong>. The 4th parameter, <a href="https://github.com/openwrt/luci/wiki/ModulesHowTo#show-me-the-way-the-dispatching-process">order</a>, has a value of <code>9</code>, which means the interface <code>/api/system/c_upload</code> doesn&rsquo;t need authorization, just like the challenge description shows: <code>you can access some internal and experimental API using an awesome bug now!</code></p>
</li>
<li>
<p><strong>(b)</strong>. check if there is a soft(symbolic) link file in the uploaded <code>.tar.gz </code> archive</p>
</li>
<li>
<p><strong>(c)</strong>.  check if the files are having their filename ends with <code>.des</code> or <code>.mbu</code></p>
</li>
<li>
<p><strong>(d)</strong>. create a new directory TMPDIR(<code>bkcfg_tmp</code>), and do the extraction step in the new directory</p>
</li>
<li>
<p><strong>(e)</strong>. check if <code>/tmp/bkcfg_tmp/cfg_backup.des</code> &amp; <code>/tmp/bkcfg_tmp/cfg_backup.mbu</code> are released</p>
</li>
<li>
<p><strong>(f)</strong>. move files from <code>/tmp/bkcfg_tmp/</code> to <code>/tmp</code> then remove <code>/tmp/bkcfg_tmp</code></p>
</li>
</ul>
<p>Part <strong>(c)</strong> is copied from <code>CVE-2020-11960</code>. The check here only checks whether the filename contains <code>mbu</code> or <code>des</code>, rather than ends with <code>.mbu</code> or <code>.des</code>. You can also check <a href="https://zhuanlan.zhihu.com/p/245070099">实战逻辑漏洞：三个漏洞搞定一台路由器</a> for the details and again, only in Chinese.</p>
<p>Compared with <code>CVE-2020-11960</code>, the extraction is in <code>/tmp/bkcfg_tmp</code>. Files won&rsquo;t be released to <code>/tmp</code>.</p>
<p>Let&rsquo;s reflect more on part <strong>(e)</strong> &amp; <strong>(f)</strong>, if we upload an archive, in which there are two files named exactly as <code>cfg_backup.des</code> and <code>cfg_backup.mbu</code>, the <strong>(e)</strong> part check will pass and files will be moved from <code>/tmp/bkcfg_tmp</code> to <code>/tmp</code> at part <strong>(f)</strong>. And then the rest exploitation is as same as <code>CVE-2020-11960</code>. The following image is the exploit file from <code>Bushwhackers</code> .</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/bushwhackers.png" alt=""></p>
<p>And <code>Sauercloud</code> used similar method.</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/sauercloud.png" alt=""></p>
<p>As you may have known, this is not the intended solution because I made some mistakes. But I still want to praise these teams for they solving this challenge in such a short time!</p>
<h3 id="the-unintended-solution-in-the-unintended-solutions">The unintended solution in the unintended solutions</h3>
<p>When hosting a CTF game, we&rsquo;re always willing to see unintended solutions, especially which we can learn from.</p>
<p>So team <code>CodeR00t</code> totally didn&rsquo;t use the <code>dnsmasq</code> thing. They chose a different way as the following image shows:</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/coder00t_exp.png" alt=""></p>
<p>They used <a href="https://en.wikipedia.org/wiki/Hard_link">hard link</a>, which begins with <code>h</code> instead of <code>l</code> in the result of <code>tar -tzvf</code>, to bypass the check of <strong>(b)</strong> to achieve <strong>arbitrary-file-write</strong> in <code>/tmp</code>(not almost-arbitrary, literally arbitrary). Then load the content of <code>iperf_script_pid</code> into shell command via some other interface.</p>
<blockquote>
<p><code>busybox</code> simplified most commands. From the result of <code>tar -tzvf</code> from <code>busybox</code>, we can&rsquo;t even see hardlink file begins with <code>h</code></p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/hardlink.png" alt=""></p>
</blockquote>
<p>This trick can also be used for <code>CVE-2020-11960</code>. Good for you, <code>CodeR00t</code>!</p>
<h2 id="writeup-for-cve-2020-14104">Writeup for CVE-2020-14104</h2>
<p>Next, I will introduce the intended solution, AKA, <code>CVE-2020-14104</code>, and how I made mistakes.</p>
<p><code>CVE-2020-14104</code> actually is a partially incomplete fix for <code>CVE-2020-11960</code>, where <strong>partially</strong> means it is not an RCE-able vuln now, but there is some flaw in the checks, which can be used to do other damage like LPE. To make this challenge, I modified the logic of <code>c_upload</code> by simply copying code from both old and new firmware without more thinking about it. More accurately, I copied code of the extraction but not the checks.</p>
<p>The following code is the new version code with checks(to make <code>CVE-2020-14104</code> RCE-able, it&rsquo;s not the same as xiaomi&rsquo;s)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">TMPDIR</span>     <span class="o">=</span> <span class="s2">&#34;bkcfg_tmp&#34;</span>
<span class="kr">function</span> <span class="nf">extract</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;nixio.fs&#34;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">tarpath</span> <span class="o">=</span> <span class="n">filepath</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">tarpath</span> <span class="kr">then</span>
        <span class="n">tarpath</span> <span class="o">=</span> <span class="n">TARMBUFILE</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="n">tarpath</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep ^l &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>								<span class="o">&lt;&lt;---</span> <span class="n">b</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep -v .des | grep -v .mbu &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>			<span class="o">&lt;&lt;---</span> <span class="n">c</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">22</span>
    <span class="kr">end</span>
    
    <span class="c1">----------------------------------------------------------													&lt;&lt;--- x</span>
    <span class="kd">local</span> <span class="n">wcl</span> <span class="o">=</span> <span class="n">io.popen</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | wc -l&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">tonumber</span><span class="p">(</span><span class="n">wcl</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;*a&#34;</span><span class="p">))</span> <span class="o">~=</span> <span class="mi">2</span> <span class="kr">then</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="n">wcl</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
    	<span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>   
    <span class="n">wcl</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
    <span class="c1">----------------------------------------------------------</span>

    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;cd /tmp; mkdir &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; cd &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; tar -xzf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>	<span class="o">&lt;&lt;---</span> <span class="n">d</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.des&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.1</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.mbu&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.2</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;mv /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/* /tmp; rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>												<span class="o">&lt;&lt;---</span> <span class="n">f</span>
    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>x</code> part code snippet checks whether there are only 2 files in the archive, which should kick the unintended solution out(I hope so).</p>
<p>I will give you a minute to try to pwn this new version challenge.</p>
<p><!-- raw HTML omitted --></p>
<p>OK, let&rsquo;s continue. When we upload a normal archive(all checks passed), the above steps can be presented as follow:</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/normal.png" alt=""></p>
<p>But when some checks failed(for example, there is no <code>cfg_backup.des</code>), there will be an extra <code>rm</code> operation:</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/fail.png" alt=""></p>
<p>See the problem? If we have two threads T1 and T2, T2&rsquo;s <code>rm -rf /tmp/bkcfg_tmp</code> happens right before T1&rsquo;s <code>cd bkcfg_tmp</code>, the <code>cd </code> operation of T1 will fail and the actual extraction will be in directory <code>/tmp/</code> again</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/race.png" alt=""></p>
<p>So it&rsquo;s a race-condition bug in the file system. That&rsquo;s why I give teams huge number of times to try for demo(5 minutes * 2 attempts * 5 times).</p>
<p>Plus, for this vuln, too many concurrent requests will have lower success rate because every upload request will do <code>mkdir</code> operation at first and change the existence of the directory  <code>/tmp/bkcfg_tmp</code>.</p>
<p>And here is my demo-show screenshot!</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/demo.png" alt=""></p>
<p><strong>See you in RWCTF 4th!</strong></p>
<blockquote>
<p>For those who are curious about how to fix this vuln. Using the <code>-C</code> parameter of <code>tar</code> should be good.</p>
<pre><code>   -C, --directory=DIR
          Change to DIR before performing any operations.   This  option  is  order-sensitive,  i.e.  it
          affects all options that follow.
</code></pre>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<ol>
<li>COVID-19 sucks. We could have had a more wonderful on-site final</li>
<li>don&rsquo;t copy &amp; paste code without fully understanding it</li>
<li>learning historical vulns is helpful to find new vulns</li>
</ol>
<p>Here I want to thank <a href="https://sec.xiaomi.com/">MiSRC</a> for allowing me to make this challenge upon their vuln. I always hold the opinion that security is the attitude. We have seen many cases that some vendors try to refuse or cover their vulnerabilities deliberately. Vendors shouldn&rsquo;t be afraid of people talking about their vulnerabilities. This only makes their products more secure. MiSRC just set an amazing example for these vendors using an open and positive attitude.</p>
<h2 id="reference">Reference</h2>
<p>[1]. <a href="https://github.com/feicong/lua_re">https://github.com/feicong/lua_re</a></p>
<p>[2]. <a href="https://bbs.pediy.com/thread-216969.htm">https://bbs.pediy.com/thread-216969.htm</a></p>
<hr>
<h1 id="rwctf-3rd-router3--cve-2020-14104-writeup">RWCTF-3rd router3 &amp; CVE-2020-14104 writeup</h1>
<p>在第三届RWCTF<!-- raw HTML omitted -->[1]<!-- raw HTML omitted -->中，我出了一道名为router3<!-- raw HTML omitted -->[2]<!-- raw HTML omitted -->的题目，考察了选手的逆向能力和漏洞挖掘能力。恭喜CodeR00t<!-- raw HTML omitted -->[3]<!-- raw HTML omitted -->，Bushwhackers<!-- raw HTML omitted -->[4]<!-- raw HTML omitted -->和Sauercloud<!-- raw HTML omitted -->[5]<!-- raw HTML omitted -->在比赛中解出了这道题目。</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/coder00t.png" alt=""></p>
<blockquote>
<p><code>CodeR00t</code>拿到一血</p>
</blockquote>
<p>接下来我会分享<code>router3</code>和相关漏洞<code>CVE-2020-14104</code>的writeup</p>
<h2 id="writeup-for-router3-1">Writeup for router3</h2>
<h3 id="题目信息">题目信息</h3>
<p><code>router3</code>的题目信息如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">router3
Score: 477

web reverse demo


Geez, you can access some internal and experimental API using an awesome bug now! Try to exploit the [router](https://rwctf2021.s3-us-west-1.amazonaws.com/router3-a2dcb2d91d0654c87ffce982a86b8794723e76d6.tar.gz) completely next!

**root password is not set in the above attachments, but set in the demo environment**
</code></pre></td></tr></table>
</div>
</div><p>附件信息如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">rwctf@rwctf:~/Desktop$ tar tvf router3.tar.gz
-rw-r--r-- root/root <span class="m">268435456</span> 2021-01-08 04:20 openwrt-armvirt-32-root.ext4
-rwxr-xr-x root/root   <span class="m">1880792</span> 2021-01-08 03:51 openwrt-armvirt-32-zImage
-rw-r--r-- root/root      <span class="m">1838</span> 2021-01-09 20:19 readme.md
-rwxr-xr-x root/root       <span class="m">749</span> 2021-01-08 03:54 start.sh
rwctf@rwctf:~/Desktop$ cat start.sh
<span class="c1">#!/bin/sh</span>
<span class="nv">IMAGE</span><span class="o">=</span>openwrt-armvirt-32-zImage
<span class="nv">LAN</span><span class="o">=</span>ledetap0
<span class="nv">DRIVE</span><span class="o">=</span>openwrt-armvirt-32-root.ext4
<span class="c1"># create tap interface which will be connected to OpenWrt LAN NIC</span>
ip tuntap add mode tap <span class="nv">$LAN</span>
ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> up
<span class="c1"># configure interface with static ip to avoid overlapping routes</span>
ip addr add 192.168.1.101/24 dev <span class="nv">$LAN</span>
qemu-system-arm <span class="se">\
</span><span class="se"></span>    -device virtio-net-pci,netdev<span class="o">=</span>lan <span class="se">\
</span><span class="se"></span>    -netdev tap,id<span class="o">=</span>lan,ifname<span class="o">=</span><span class="nv">$LAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\
</span><span class="se"></span>    -device virtio-net-pci,netdev<span class="o">=</span>wan <span class="se">\
</span><span class="se"></span>    -netdev user,id<span class="o">=</span>wan <span class="se">\
</span><span class="se"></span>    -drive <span class="nv">file</span><span class="o">=</span><span class="nv">$DRIVE</span>,format<span class="o">=</span>raw,if<span class="o">=</span>virtio -append <span class="s1">&#39;root=/dev/vda rootwait&#39;</span> <span class="se">\
</span><span class="se"></span>    -M virt -nographic -m <span class="m">256</span> -kernel <span class="nv">$IMAGE</span>
<span class="c1"># cleanup. delete tap interface created earlier</span>
ip addr flush dev <span class="nv">$LAN</span>
ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> down
ip tuntap del mode tap dev <span class="nv">$LAN</span>
rwctf@rwctf:~/Desktop$ file openwrt-armvirt-32-*
openwrt-armvirt-32-root.ext4: Linux rev 1.0 ext2 filesystem data <span class="o">(</span>mounted or unclean<span class="o">)</span>, <span class="nv">UUID</span><span class="o">=</span>57f8f4bc-abf4-655f-bf67-946fc0f9f25b <span class="o">(</span>extents<span class="o">)</span> <span class="o">(</span>large files<span class="o">)</span>
openwrt-armvirt-32-zImage:    ARM OpenFirmware FORTH Dictionary, Text length: -509607936 bytes, Data length: -509607936 bytes, Text Relocation Table length: -369098749 bytes, Data Relocation Table length: <span class="m">24061976</span> bytes, Entry Point: 0x00000000, BSS length: <span class="m">1880792</span> bytes
</code></pre></td></tr></table>
</div>
</div><p>提供给了选手一个通过qemu启动，基于openwrt<!-- raw HTML omitted -->[6]<!-- raw HTML omitted -->的mips虚拟机。在<code>readme.md</code>中描述了选手的目标是更改<code>/www/index.html</code>，也就是需要实现任意文件写或者RCE</p>
<p>总结以上信息：</p>
<ul>
<li>题目类型？
<ul>
<li>web &amp; reverse</li>
</ul>
</li>
<li>提供给选手的附件
<ul>
<li>一个mips虚拟机</li>
</ul>
</li>
<li>选手需要达成的目标
<ul>
<li>RCE（任意文件写最终可以转化为RCE）</li>
</ul>
</li>
</ul>
<h3 id="分析题目">分析题目</h3>
<p>题目的标签是<code>web</code>和<code>reverse</code>。使用<code>start.sh</code>启动虚拟机后，通过<code>netstat</code>和<code>ps</code>的结果可以看出唯一和<code>web</code>有关的进程是nginx<!-- raw HTML omitted -->[7]<!-- raw HTML omitted --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:/# netstat -antpl
netstat: showing only processes with your user ID
Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      935/nginx.conf -g d
......
root@OpenWrt:/# ps
  PID USER       VSZ STAT COMMAND
......
  <span class="m">935</span> root      <span class="m">2404</span> S    nginx: master process /usr/sbin/nginx -c /etc/nginx/
  <span class="m">958</span> root      <span class="m">2452</span> S    nginx: worker process
.....
</code></pre></td></tr></table>
</div>
</div><p>并且虚拟机中启用了luci<!-- raw HTML omitted -->[8]<!-- raw HTML omitted -->，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:~# ls /www/
cgi-bin      index.html   luci-static
root@OpenWrt:~# ls /www/cgi-bin/
cgi-backup    cgi-download  cgi-exec      cgi-upload    luci
</code></pre></td></tr></table>
</div>
</div><h4 id="luci--luasup9sup--ucisup10sup">luci = lua<!-- raw HTML omitted -->[9]<!-- raw HTML omitted --> + uci<!-- raw HTML omitted -->[10]<!-- raw HTML omitted --></h4>
<p>简单来说，luci是一种MVC<!-- raw HTML omitted -->[11]<!-- raw HTML omitted -->框架，主要使用了Lua语言实现后端（更多的细节请参考官方文档）</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/MVC.svg" alt=""></p>
<p>在MVC框架中，用户可以直接交互的是<code>controller</code>，对应到题目也就是<code>/usr/lib/lua/luci/controller</code>部分的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:~# ls /usr/lib/lua/luci/controller/ -R
/usr/lib/lua/luci/controller/:
admin         api           firewall.lua  opkg.lua

/usr/lib/lua/luci/controller/admin:
index.lua    network.lua  uci.lua

/usr/lib/lua/luci/controller/api:
index.lua   system.lua
</code></pre></td></tr></table>
</div>
</div><p>与标准的openwrt系统相比较，可以发现题目环境中多了<code>/usr/lib/lua/luci/controller/api/system.lua</code>。那么很明显这也就是选手应该关注的代码了。</p>
<p>从文件系统中拿到<code>system.lua</code>后可以发现这是一个ELF文件，<del>因此启动IDA pro开始逆向</del></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">rwctf@rwctf:~/Desktop$ file system.lua
system.lua: ELF 32-bit invalid byte order <span class="o">(</span>SYSV<span class="o">)</span>
rwctf@rwctf:~/Desktop$ hexdump -C -n <span class="m">20</span> ./system.lua
<span class="m">00000000</span>  7f <span class="m">45</span> 4c <span class="m">46</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>  <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">05</span>  <span class="p">|</span>.ELF............<span class="p">|</span>
<span class="m">00000010</span>  <span class="m">02</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span>                                       <span class="p">|</span>....<span class="p">|</span>
<span class="m">00000014</span>
rwctf@rwctf:~/Desktop$ chmod +x system.lua <span class="p">;</span> ./system.lua
Hello world
</code></pre></td></tr></table>
</div>
</div><p>之前已经说过<code>luci</code>的后端多是由lua实现的，如果我们在虚拟机中查看lua版本的话，立刻就可以发现虚拟机中使用了一个更改过的lua binary</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/lua.png" alt=""></p>
<p>这里也就是题目标签<code>reverse</code>所设立的考点了。选手在审计lua代码挖掘漏洞之前，必须先做一些逆向工作找到lua被改了哪些部分并写出反编译器。网上已经有很多详细的教程，我在这里就不再赘述如何一步一步逆向并写反编译器了。在文末有一些参考链接<!-- raw HTML omitted -->[11] [12]<!-- raw HTML omitted -->和题目中应用的diff文件<!-- raw HTML omitted -->[13]<!-- raw HTML omitted -->。</p>
<h3 id="cve-2020-11960sup14sup">CVE-2020-11960<!-- raw HTML omitted -->[14]<!-- raw HTML omitted --></h3>
<p>在更进一步分析题目之前，我们先看一下另一个相关的漏洞CVE-2020-11960。我在去年的HITCON会议上展示过该漏洞的挖掘和利用过程（slides<!-- raw HTML omitted -->[15]<!-- raw HTML omitted -->的33~55页）。这里简要叙述一下如何利用该漏洞：</p>
<ol>
<li>通过上传文件时文件名检测的不严格上传两个文件<code>/tmp/hack_des.sh</code>和<code>/tmp/dnsmasq.d/mbu.conf</code>，其中<code>hack_des.sh</code>是一个包含了任意命令的shell脚本，<code>mbu.conf</code>是dnsmasq<!-- raw HTML omitted -->[16]<!-- raw HTML omitted -->的配置文件</li>
<li>通过某种方式重启dnsmasq，加载<code>mbu.conf</code></li>
<li>通过<code>tftp</code>传输文件，触发<code>mbu.conf</code>中指定的<code>hack_des.sh</code></li>
</ol>
<p>其中后两步是具体的利用，漏洞主要发生在第一步，攻击者首先需要能够在<code>/tmp</code>目录下上传包含特殊内容且文件名符合要求的文件。</p>
<h3 id="选手writeup">选手writeup</h3>
<p>回到题目上。为了节省选手的时间，我删除了大量<code>system.lua</code>中的代码，只保留了少部分接口。观察如下<code>/api/system/c_upload</code>接口的相关代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- /usr/lib/lua/luci/controller/api/system.lua</span>
	<span class="n">entry</span><span class="p">({</span><span class="s2">&#34;api&#34;</span><span class="p">,</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;c_upload&#34;</span><span class="p">},</span>              <span class="n">call</span><span class="p">(</span><span class="s2">&#34;cUpload&#34;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="mi">153</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span>							<span class="o">&lt;&lt;---</span> <span class="n">a</span>

<span class="kr">function</span> <span class="nf">cUpload</span><span class="p">()</span>
<span class="p">......</span>
    <span class="kd">local</span> <span class="n">uploadFilepath</span> <span class="o">=</span> <span class="s2">&#34;/tmp/cfgbackup.tar.gz&#34;</span>
<span class="p">......</span>
        <span class="kd">local</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">XQBackup.extract</span><span class="p">(</span><span class="n">uploadFilepath</span><span class="p">)</span>
<span class="p">......</span>
<span class="kr">end</span>

<span class="c1">-- /usr/lib/lua/xiaoqiang/module/XQBackup.lua</span>
<span class="kd">local</span> <span class="n">TMPDIR</span>     <span class="o">=</span> <span class="s2">&#34;bkcfg_tmp&#34;</span>

<span class="kr">function</span> <span class="nf">extract</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;nixio.fs&#34;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">tarpath</span> <span class="o">=</span> <span class="n">filepath</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">tarpath</span> <span class="kr">then</span>
        <span class="n">tarpath</span> <span class="o">=</span> <span class="n">TARMBUFILE</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="n">tarpath</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep ^l &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>								<span class="o">&lt;&lt;---</span> <span class="n">b</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep -v .des | grep -v .mbu &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>			<span class="o">&lt;&lt;---</span> <span class="n">c</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">22</span>
    <span class="kr">end</span>

    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;cd /tmp; mkdir &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; cd &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; tar -xzf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>	<span class="o">&lt;&lt;---</span> <span class="n">d</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.des&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.1</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.mbu&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.2</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;mv /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/* /tmp; rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>												<span class="o">&lt;&lt;---</span> <span class="n">f</span>
    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>有以下关键点：</p>
<p><strong>(a)</strong>. <code>/api/system/c_upload</code>的第四个参数(order<!-- raw HTML omitted -->[16]<!-- raw HTML omitted -->)是9，即该接口无需认证即可访问（在题目描述中也暗示了这一点：<code>you can access some internal and experimental API using an awesome bug now</code>）</p>
<p><strong>(b)</strong>. 检查上传的<code>.tar.gz</code>压缩包中是否有软链接文件</p>
<p><strong>(c)</strong>. 检查压缩包中文件的文件名是否以<code>.des</code>或者<code>.mbu</code>结尾</p>
<p><strong>(d)</strong>. 创建一个新的文件夹<code>/tmp/bkcfg_tmp</code>，并在新文件夹下完成解压的步骤</p>
<p><strong>(e)</strong>. 检查<code>/tmp/bkcfg_tmp/cfg_backup.des</code>和<code>/tmp/bkcfg_tmp/cfg_backup.mbu</code>是否被释放</p>
<p><strong>(f)</strong>. 拷贝<code>/tmp/bkcfg_tmp</code>下的文件到<code>/tmp/</code>，然后删除<code>/tmp/bkcfg_tmp</code></p>
<p>其中**(c)**部分的代码包含与<code>CVE-2020-11960</code>一样的缺陷，只检查了文件名中是否包含<code>des</code>和<code>mbu</code>字符串而非检查是否以<code>.des</code>或<code>.mbu</code>结尾，关于这一点，也可以参考<a href="https://zhuanlan.zhihu.com/p/245070099">实战逻辑漏洞：三个漏洞搞定一台路由器</a>。</p>
<p>和<code>CVE-2020-11960</code>相比，文件的解压都在<code>/tmp/bkcfg_tmp</code>下完成，看起来<code>CVE-2020-11960</code>的利用手法在这里不适用。但仔细检查**(e)**和**(f)**部分的代码，如果我们上传一个压缩包，压缩包中刚好有两个文件名为<code>cfg_backup.mbu</code>和<code>cfg_backup.des</code>的文件，**(e)**处的检查就会通过，进而在**(f)**处，<code>/tmp/bkcfg_tmp</code>下的文件又被重新拷贝回<code>/tmp</code>。通过构造特殊的压缩包，我们就可以再次获得在<code>/tmp</code>目录下上传特殊文件的能力，接下来的利用也就和<code>CVE-2020-11960</code>一样了。而比赛中<code>Bushwhackers</code>和<code>Sauercloud</code>正是使用了这样的方法。</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/bushwhackers.png" alt=""></p>
<blockquote>
<p>Bushwhackers的exploit</p>
</blockquote>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/sauercloud.png" alt=""></p>
<blockquote>
<p>Sauercloud的黑页</p>
</blockquote>
<p>这种解法并不是预期解，出题的过程中我犯了一些错误导致所有的队伍都使用了非预期解法。但解出题目的队伍在短短48h就写出了反编译器并找到了漏洞，证明了他们身为世界顶级战队的实力。</p>
<h3 id="非预期中的非预期">非预期中的非预期</h3>
<p>在举办CTF比赛时，我们很乐意看到非预期解，尤其是能让我们学到东西的非预期解法。在比赛中，<code>CodeR00t</code>虽然也使用了同一个bug，但他们完全没有使用<code>dnsmasq</code>相关的利用手法，而是找到了一种新的利用思路。</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/coder00t_exp.png" alt=""></p>
<p>上图是<code>CodeR00t</code>的exploit，他们使用了硬链接<!-- raw HTML omitted -->[17]<!-- raw HTML omitted -->来绕过**(b)**处的检查，在<code>tar -tzvf</code>的结果中，硬链接以<code>h</code>开头，而**(b)**处只检查了是否以<code>l</code>开头。**(b)**处的检查绕过后，利用硬链接的特性，攻击者可以实现**完整的任意写文件**。</p>
<blockquote>
<p>busybox精简了大量的命令，在虚拟机中使用<code>tar -tzvf</code>时甚至看不到硬链接以<code>h</code>开头</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/hardlink.png" alt=""></p>
</blockquote>
<p>这种利用方法也能用到<code>CVE-2020-11960</code>上:P</p>
<h2 id="writeup-for-cve-2020-14104-1">Writeup for CVE-2020-14104</h2>
<p>接下来我会介绍题目的预期解法以及我如何犯了一个错误导致了非预期解的产生。</p>
<p><code>router3</code>实际上重现了一遍<code>CVE-2020-14104</code>，<code>CVE-2020-14104</code>是一个<code>CVE-2020-11960</code>的<strong>部分</strong>不完整修复。<strong>部分</strong>的意思是该修复方法使得该处不能RCE，但在检查过程中的疏忽导致该漏洞仍然可以造成诸如LPE之类的危害。为了让题目可RCE，我修改了（ctrl^c+ctrl^v）小米代码的部分逻辑，但只拷贝了旧版固件的解压部分代码，而没有拷贝新版固件中的检查部分代码。</p>
<p>下边是带有检查的<code>/api/system/c_upload</code>接口代码（与小米原生的逻辑不同）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">TMPDIR</span>     <span class="o">=</span> <span class="s2">&#34;bkcfg_tmp&#34;</span>
<span class="kr">function</span> <span class="nf">extract</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;nixio.fs&#34;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">tarpath</span> <span class="o">=</span> <span class="n">filepath</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">tarpath</span> <span class="kr">then</span>
        <span class="n">tarpath</span> <span class="o">=</span> <span class="n">TARMBUFILE</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="n">tarpath</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep ^l &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>								<span class="o">&lt;&lt;---</span> <span class="n">b</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>

    <span class="kr">if</span> <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | grep -v .des | grep -v .mbu &gt;/dev/null 2&gt;&amp;1&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>			<span class="o">&lt;&lt;---</span> <span class="n">c</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">22</span>
    <span class="kr">end</span>
    
    <span class="c1">----------------------------------------------------------													&lt;&lt;--- x</span>
    <span class="kd">local</span> <span class="n">wcl</span> <span class="o">=</span> <span class="n">io.popen</span><span class="p">(</span><span class="s2">&#34;tar -tzvf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; | wc -l&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">tonumber</span><span class="p">(</span><span class="n">wcl</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;*a&#34;</span><span class="p">))</span> <span class="o">~=</span> <span class="mi">2</span> <span class="kr">then</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="p">)</span>
        <span class="n">wcl</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
    	<span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>   
    <span class="n">wcl</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
    <span class="c1">----------------------------------------------------------</span>

    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;cd /tmp; mkdir &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; cd &#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;; tar -xzf &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>	<span class="o">&lt;&lt;---</span> <span class="n">d</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm &#34;</span><span class="o">..</span><span class="n">tarpath</span><span class="o">..</span><span class="s2">&#34; &gt;/dev/null 2&gt;/dev/null&#34;</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.des&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.1</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">2</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">fs.access</span><span class="p">(</span><span class="s2">&#34;/tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/cfg_backup.mbu&#34;</span><span class="p">)</span> <span class="kr">then</span>													<span class="o">&lt;&lt;---</span> <span class="n">e</span><span class="mf">.2</span>
        <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="kr">return</span> <span class="mi">3</span>
    <span class="kr">end</span>
    <span class="n">os.execute</span><span class="p">(</span><span class="s2">&#34;mv /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="o">..</span><span class="s2">&#34;/* /tmp; rm -rf /tmp/&#34;</span><span class="o">..</span><span class="n">TMPDIR</span><span class="p">)</span>												<span class="o">&lt;&lt;---</span> <span class="n">f</span>
    <span class="kr">return</span> <span class="mi">0</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>**(x)**部分的代码检查了上传的压缩包中是否只有两个文件，理论上应该会缓解上一节介绍的非预期解。</p>
<p>有了以上的基础，我在这里暂停一下看读者能否发现新版代码中的漏洞。</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/1minute.jpg" alt=""></p>
<p>继续分析，当用户上传一个正常的压缩包时，对该压缩包的处理逻辑可以用下图来表示</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/normal.png" alt=""></p>
<p>但如果某些检查没有通过(比如压缩包中没有<code>cfg_backup.des</code>)，就会额外有一步<code>rm</code>的操作</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/fail.png" alt=""></p>
<p>而多出的这一步<code>rm</code>也就是关键点。让我们思考这样一种情况：当虚拟机同时处理多个请求时，若一个请求中的<code>rm -rf /tmp/bkcfg_tmp</code>刚好发生在另一个请求的<code>cd bkcfg_tmp</code>之前时，因为<code>/tmp/bkcfg_tmp</code>已经不存在了，因此<code>cd</code>会失败，当前请求的CWD仍然是<code>/tmp</code>，整个流程可以用下图来表示</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/race.png" alt=""></p>
<p>因此通过文件系统中的条件竞争，攻击者再一次获得了在<code>/tmp</code>目录下上传特定文件的能力，接下来的利用就可以参考上文介绍的方法了。比赛中为了我给了选手大量的试错机会赢得竞争（5分钟*2次机会*5次尝试），但因为所有的队伍都用了非预期解，所以他们都在20秒内就实现了RCE.</p>
<p>下图是我的demo截图：</p>
<p><img src="../pic/RWCTF-3rd_router3_&amp;_CVE_2020_14104/demo.png" alt=""></p>
<blockquote>
<p>修复该漏洞可以使用<code>tar</code>的<code>-C</code>参数</p>
</blockquote>
<blockquote>
<pre><code>   -C, --directory=DIR
          Change to DIR before performing any operations.   This  option  is  order-sensitive,  i.e.  it
          affects all options that follow.
</code></pre>
</blockquote>
<h2 id="总结">总结</h2>
<ol>
<li>因为疫情，本届RWCTF没有决赛，期待明年春暖花开后在第4届RWCTF决赛现场看到各位师傅</li>
<li>在完全理解代码含义之前，不要盲目的复制&amp;粘贴代码</li>
<li>学习历史漏洞可以帮助我们发现新的漏洞</li>
</ol>
<p>这里我想要感谢MiSRC<!-- raw HTML omitted -->[18]<!-- raw HTML omitted -->允许我使用他们的漏洞出题。我一直认为评判产品是否安全需要看厂商对待漏洞的态度。历史上我们也看到过某些厂商故意忽略或者掩盖他们漏洞的例子。厂商不应该担心安全从业者讨论他们的漏洞，这只会让他们的产品更安全，在这一点上MiSRC做出了一个很积极开放的榜样。</p>
<h2 id="reference-1">Reference</h2>
<p>[1]. <a href="https://ctftime.org/event/1198">https://ctftime.org/event/1198</a></p>
<p>[2]. <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3">https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3</a></p>
<p>[3]. <a href="https://ctftime.org/team/143448">https://ctftime.org/team/143448</a></p>
<p>[4]. <a href="https://blog.bushwhackers.ru/">https://blog.bushwhackers.ru/</a></p>
<p>[5]. <a href="https://twitter.com/Sauercl0ud">https://twitter.com/Sauercl0ud</a></p>
<p>[6]. <a href="http://openwrt.org/">http://openwrt.org/</a></p>
<p>[7]. <a href="https://openwrt.org/docs/guide-user/services/webserver/nginx">https://openwrt.org/docs/guide-user/services/webserver/nginx</a></p>
<p>[8]. <a href="https://openwrt.org/docs/techref/luci">https://openwrt.org/docs/techref/luci</a></p>
<p>[9]. <a href="http://www.lua.org/">http://www.lua.org/</a></p>
<p>[10]. <a href="https://openwrt.org/docs/techref/uci">https://openwrt.org/docs/techref/uci</a></p>
<p>[11]. <a href="https://github.com/feicong/lua_re">https://github.com/feicong/lua_re</a></p>
<p>[12]. <a href="https://bbs.pediy.com/thread-216969.htm">https://bbs.pediy.com/thread-216969.htm</a></p>
<p>[13]. <a href="https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3/files/310-rwctf-router3.patch">https://github.com/chaitin/Real-World-CTF-3rd-Challenge-Attachments/tree/main/router3/files/310-rwctf-router3.patch</a></p>
<p>[14]. <a href="https://privacy.mi.com/trust#/security/vulnerability-management/vulnerability-announcement/detail?id=15&amp;locale=en">https://privacy.mi.com/trust#/security/vulnerability-management/vulnerability-announcement/detail?id=15&amp;locale=en</a></p>
<p>[15]. <a href="https://hitcon.org/2020/slides/Exploit%20(Almost)%20All%20Xiaomi%20Routers%20Using%20Logical%20Bugs.pdf">https://hitcon.org/2020/slides/Exploit%20(Almost)%20All%20Xiaomi%20Routers%20Using%20Logical%20Bugs.pdf</a></p>
<p>[16]. <a href="https://github.com/openwrt/luci/wiki/ModulesHowTo#show-me-the-way-the-dispatching-process">https://github.com/openwrt/luci/wiki/ModulesHowTo#show-me-the-way-the-dispatching-process</a></p>
<p>[17]. <a href="https://en.wikipedia.org/wiki/Hard_link">https://en.wikipedia.org/wiki/Hard_link</a></p>
<p>[18]. <a href="https://sec.xiaomi.com/">https://sec.xiaomi.com/</a></p>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bash-c.github.io/tags/iot/">IoT</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/exploiting-ax3600-using-logical-bugs/">
            <span class="next-text nav-default">Exploiting AX3600 Using Logical Bugs</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:aboultraman@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/M4x_1997" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/bash-c" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bash-c.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        M4x
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
